<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ORBITRON TERMINAL v8.4 - OVERLOAD</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --n: #00f2ff; --p: #ff00ff; --bg: #01050a; 
            --gl: rgba(5, 15, 25, 0.95); --border: rgba(0, 242, 255, 0.4);
            --shadow: 0 0 20px rgba(0, 242, 255, 0.2);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--n); font-family: 'Share Tech Mono', monospace; height: 100vh; overflow: hidden; }

        /* CRT Effects */
        .crt::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 1000; background-size: 100% 3px, 3px 100%; pointer-events: none;
        }
        .vignette {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.8) 100%);
            z-index: 1001; pointer-events: none;
        }

        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* UI Structure */
        .ui-grid {
            position: relative; z-index: 10;
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            grid-template-rows: 1fr 150px;
            height: 100vh; gap: 15px; padding: 20px;
            pointer-events: none;
        }

        .panel {
            background: var(--gl); border: 1px solid var(--border);
            pointer-events: auto; backdrop-filter: blur(12px);
            display: flex; flex-direction: column;
            box-shadow: var(--shadow);
            position: relative;
        }
        .panel::after {
            content: ""; position: absolute; top: -1px; left: -1px; width: 10px; height: 10px;
            border-top: 2px solid var(--n); border-left: 2px solid var(--n);
        }

        /* Tabs */
        .tab-bar { display: flex; background: rgba(0,0,0,0.3); }
        .tab { 
            flex: 1; padding: 15px; text-align: center; cursor: pointer; 
            font-family: 'Orbitron'; font-size: 11px; border-bottom: 1px solid var(--border);
            transition: 0.3s; opacity: 0.5;
        }
        .tab.active { opacity: 1; border-bottom: 2px solid var(--n); background: rgba(0,242,255,0.05); }

        /* Chat */
        #chat-window { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .msg-block { margin-bottom: 15px; border-left: 2px solid var(--border); padding-left: 15px; }
        .msg-header { font-size: 10px; color: var(--p); margin-bottom: 5px; font-weight: bold; }
        .msg-content { color: #e0faff; line-height: 1.4; }

        /* Inputs */
        .input-group { padding: 20px; display: flex; gap: 10px; border-top: 1px solid var(--border); }
        input[type="text"], input[type="email"], input[type="password"] {
            background: rgba(0,0,0,0.6); border: 1px solid var(--border);
            color: var(--n); padding: 12px; font-family: inherit; flex-grow: 1; outline: none;
        }
        input:focus { border-color: var(--n); box-shadow: 0 0 10px rgba(0,242,255,0.2); }
        button {
            background: transparent; border: 1px solid var(--n); color: var(--n);
            padding: 10px 20px; font-family: 'Orbitron'; cursor: pointer; transition: 0.3s;
        }
        button:hover { background: var(--n); color: #000; }

        .hidden { display: none; }
        #sys-logs { 
            grid-column: 1 / 4; font-size: 11px; padding: 10px; 
            color: #666; display: flex; flex-direction: column-reverse; overflow: hidden;
        }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; }
        .progress-bg { height: 4px; background: #111; width: 100%; margin-top: 4px; }
        .progress-fill { height: 100%; background: var(--n); box-shadow: 0 0 10px var(--n); }
    </style>
</head>
<body class="crt">

<div class="vignette"></div>
<canvas id="canvas-bg"></canvas>

<div class="ui-grid">
    <aside class="panel">
        <div class="tab-bar">
            <div class="tab active" onclick="ui.switchTab('logs')">LOGS</div>
            <div class="tab" onclick="ui.switchTab('crew')">CREW</div>
        </div>
        <div id="tab-logs" class="sidebar-body" style="padding:20px;">
            <h3 style="font-size:10px; margin-bottom:15px; letter-spacing:2px;">MISSION_DATA</h3>
            <input type="text" id="todo-input" placeholder="> RECORD ENTRY..." style="width:100%; margin-bottom:15px;">
            <div id="todo-container"></div>
        </div>
        <div id="tab-crew" class="sidebar-body hidden" style="padding:20px;">
            <div class="stat-row"><span>O2 RESERVE</span><span>94%</span></div>
            <div class="progress-bg"><div class="progress-fill" style="width:94%"></div></div>
            <div style="margin-top:20px;" class="stat-row"><span>FUEL CELLS</span><span>67%</span></div>
            <div class="progress-bg"><div class="progress-fill" style="width:67%; background:var(--p); box-shadow: 0 0 10px var(--p);"></div></div>
        </div>
    </aside>

    <main style="display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div class="panel" style="width:100%; max-width:800px; height:600px;">
            <div id="auth-gate" style="padding:60px;">
                <h1 style="font-family:'Orbitron'; text-align:center; margin-bottom:40px; letter-spacing:5px;">ACCESS_GATE</h1>
                <input type="email" id="user-email" placeholder="PILOT_ID" style="width:100%; margin-bottom:15px;">
                <input type="password" id="user-pass" placeholder="SECURITY_KEY" style="width:100%; margin-bottom:25px;">
                <button onclick="engine.auth('in')" style="width:100%; padding:15px;">INITIALIZE_LINK</button>
                <button onclick="engine.auth('up')" style="width:100%; margin-top:10px; border:none; font-size:10px; color:var(--p);">REGISTER_NEW_PILOT</button>
            </div>
            
            <div id="terminal-interface" class="hidden" style="display:flex; flex-direction:column; height:100%;">
                <div id="chat-window"></div>
                <div class="input-group">
                    <input type="text" id="chat-input" placeholder="READY FOR COMMANDS...">
                    <button onclick="engine.sendMsg()">TRANSMIT</button>
                </div>
            </div>
        </div>
    </main>

    <aside class="panel" style="padding:20px;">
        <h2 style="font-family:'Orbitron'; font-size:11px; margin-bottom:20px; color:var(--p);">SCANNER_OUTPUT</h2>
        <div id="telemetry" style="font-size:12px; line-height:2;">
            SECTOR: X-99<br>
            OBJ_DETECTED: 14<br>
            RAD_LEVEL: NOMINAL<br>
            LOCAL_TIME: <span id="sys-time">00:00:00</span>
        </div>
    </aside>

    <footer class="panel" id="sys-logs">
        <div>[SYSTEM] KERNEL_LOADED: BUILD_8.4</div>
    </footer>
</div>

<script>
/**
 * ORBITRON CORE ENGINE v8.4
 * Полная переработка графики и логики.
 */

const ui = {
    switchTab: (name) => {
        document.getElementById('tab-logs').classList.toggle('hidden', name !== 'logs');
        document.getElementById('tab-crew').classList.toggle('hidden', name !== 'crew');
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.innerText.toLowerCase() === name));
        engine.log('INTERFACE_SWITCH: ' + name.toUpperCase());
    }
};

const engine = {
    sb: window.supabase.createClient('https://ebjsxlympwocluxgmwcu.supabase.co', 'sb_publishable_8HhPj3Y8g5V7Np8Vy5xbzQ_2B7LjTkj'),
    user: null,

    log: (msg) => {
        const l = document.getElementById('sys-logs');
        const d = document.createElement('div');
        d.innerHTML = `<span style="color:var(--n)">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
        l.prepend(d);
        if(l.children.length > 8) l.lastChild.remove();
    },

    auth: async (type) => {
        const e = document.getElementById('user-email').value;
        const p = document.getElementById('user-pass').value;
        engine.log('AUTH_REQUEST: ' + (type === 'in' ? 'LOGIN' : 'SIGNUP'));
        const { data, error } = type === 'in' 
            ? await engine.sb.auth.signInWithPassword({email:e, password:p})
            : await engine.sb.auth.signUp({email:e, password:p});
        if(error) { alert(error.message); engine.log('AUTH_ERROR: ' + error.message); }
    },

    sendMsg: async () => {
        const i = document.getElementById('chat-input');
        if(!i.value || !engine.user) return;
        const nick = engine.user.email.split('@')[0];
        const text = i.value; i.value = '';
        
        // Optimistic UI
        engine.renderMessage({ nickname: nick, message: text, created_at: new Date() });
        await engine.sb.from('comments').insert([{ message: text, nickname: nick }]);
    },

    renderMessage: (m) => {
        const w = document.getElementById('chat-window');
        const b = document.createElement('div');
        b.className = 'msg-block';
        b.innerHTML = `
            <div class="msg-header">${(m.nickname || 'PILOT').toUpperCase()} // ${new Date(m.created_at).toLocaleTimeString()}</div>
            <div class="msg-content">${m.message}</div>
        `;
        w.appendChild(b);
        w.scrollTop = w.scrollHeight;
    }
};

// --- GRAPHICS ENGINE ---
const canvas = document.getElementById('canvas-bg');
const ctx = canvas.getContext('2d');

class Star {
    constructor() { this.reset(); }
    reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.s = Math.random() * 2;
        this.p = Math.random() * 3;
    }
    draw(mx, my) {
        ctx.fillStyle = "#fff";
        ctx.globalAlpha = Math.random();
        ctx.beginPath();
        ctx.arc(this.x + mx * this.p, this.y + my * this.p, this.s/2, 0, 7);
        ctx.fill();
    }
}

class Astronaut {
    constructor() {
        this.x = Math.random() * 500;
        this.y = Math.random() * 500;
        this.v = 0.2;
        this.angle = 0;
    }
    draw() {
        this.x += this.v; this.angle += 0.005;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        
        // Body & Suit
        ctx.fillStyle = "#fff";
        ctx.beginPath(); ctx.roundRect(-10, -12, 20, 28, 5); ctx.fill(); // Torso
        ctx.beginPath(); ctx.arc(0, -15, 10, 0, 7); ctx.fill(); // Helmet
        
        // Visor
        ctx.fillStyle = "#05101a";
        ctx.beginPath(); ctx.roundRect(-7, -19, 14, 8, 3); ctx.fill();
        
        // Limbs (Arms & Legs)
        ctx.strokeStyle = "#fff"; ctx.lineWidth = 4; ctx.lineCap = "round";
        ctx.beginPath(); ctx.moveTo(-10, -5); ctx.lineTo(-18, 5); ctx.stroke(); // L Arm
        ctx.beginPath(); ctx.moveTo(10, -5); ctx.lineTo(18, 5); ctx.stroke();  // R Arm
        ctx.beginPath(); ctx.moveTo(-5, 15); ctx.lineTo(-10, 30); ctx.stroke(); // L Leg
        ctx.beginPath(); ctx.moveTo(5, 15); ctx.lineTo(10, 30); ctx.stroke();  // R Leg
        
        // Backpack
        ctx.fillStyle = "#ddd"; ctx.fillRect(-12, -8, 4, 15);
        
        ctx.restore();
    }
}

class Asteroid {
    constructor() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * canvas.height;
        this.points = [];
        for(let i=0; i<8; i++) {
            this.points.push({
                x: Math.cos(i * Math.PI/4) * (15 + Math.random()*10),
                y: Math.sin(i * Math.PI/4) * (15 + Math.random()*10)
            });
        }
    }
    draw(mx, my) {
        ctx.save();
        ctx.translate(this.x + mx*2, this.y + my*2);
        ctx.strokeStyle = "rgba(0, 242, 255, 0.3)";
        ctx.beginPath();
        ctx.moveTo(this.points[0].x, this.points[0].y);
        this.points.forEach(p => ctx.lineTo(p.x, p.y));
        ctx.closePath(); ctx.stroke();
        ctx.restore();
    }
}

const world = {
    stars: Array.from({length: 150}, () => new Star()),
    rocks: Array.from({length: 10}, () => new Asteroid()),
    pilot: new Astronaut(),
    mx: 0, my: 0,
    
    init() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        window.addEventListener('mousemove', (e) => {
            this.mx = (e.clientX - canvas.width/2) / 50;
            this.my = (e.clientY - canvas.height/2) / 50;
        });
    },

    render() {
        ctx.fillStyle = "#01050a"; ctx.fillRect(0,0,canvas.width, canvas.height);
        
        this.stars.forEach(s => s.draw(this.mx, this.my));
        this.rocks.forEach(r => r.draw(this.mx, this.my));
        
        // Planet
        const px = canvas.width * 0.8 + this.mx * 3;
        const py = canvas.height * 0.3 + this.my * 3;
        
        // Atmosphere
        const glow = ctx.createRadialGradient(px, py, 60, px, py, 110);
        glow.addColorStop(0, 'rgba(0, 242, 255, 0.15)'); glow.addColorStop(1, 'transparent');
        ctx.fillStyle = glow; ctx.beginPath(); ctx.arc(px, py, 110, 0, 7); ctx.fill();
        
        // Surface
        const surf = ctx.createRadialGradient(px-30, py-30, 10, px, py, 80);
        surf.addColorStop(0, '#004466'); surf.addColorStop(1, '#000810');
        ctx.fillStyle = surf; ctx.beginPath(); ctx.arc(px, py, 80, 0, 7); ctx.fill();

        this.pilot.draw();
        
        document.getElementById('sys-time').innerText = new Date().toLocaleTimeString();
        requestAnimationFrame(() => this.render());
    }
};

// --- INITIALIZE ALL ---
engine.sb.auth.onAuthStateChange((_, s) => {
    if(s) {
        engine.user = s.user;
        document.getElementById('auth-gate').classList.add('hidden');
        document.getElementById('terminal-interface').classList.remove('hidden');
        engine.log('LINK_ESTABLISHED: ' + engine.user.email);
        
        // Load messages
        engine.sb.from('comments').select('*').order('created_at', {ascending:true})
            .then(({data}) => data && data.forEach(m => engine.renderMessage(m)));
    }
});

// To-Do Logic (Isolated)
document.getElementById('todo-input').onkeypress = (e) => {
    if(e.key === 'Enter' && e.target.value) {
        const val = e.target.value.toUpperCase(); e.target.value = '';
        const d = document.createElement('div');
        d.style = "padding:10px; border-bottom:1px solid #111; font-size:11px; cursor:pointer;";
        d.innerText =  $;{val};
        d.onclick = () => d.remove();
        document.getElementById('todo-container').prepend(d);
    }
};

world.init();
world.render();
</script>
</body>
</html>