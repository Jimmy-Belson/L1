<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ORBITRON TERMINAL v7.4</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --n: #00f2ff; --p: #ff00ff; --bg: #01050a; --gl: rgba(5, 15, 25, 0.9); }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: var(--n); font-family: 'Share Tech Mono', monospace; height: 100vh; overflow: hidden; }
        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; pointer-events: none; }
        .sidebar { width: 320px; height: 100%; background: var(--gl); border-right: 1px solid var(--n); padding: 30px; pointer-events: auto; backdrop-filter: blur(15px); display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .terminal { width: 650px; background: var(--gl); border: 1px solid var(--n); padding: 30px; pointer-events: auto; position: relative; backdrop-filter: blur(12px); border-radius: 4px; }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-4px, 2px); filter: hue-rotate(45deg); } 100% { transform: translate(0); } }
        .glitch-active { animation: glitch 0.2s linear 2; }
        #chat-box { height: 400px; overflow-y: auto; margin-bottom: 20px; display: flex; flex-direction: column; padding-right: 10px; }
        .msg { background: rgba(0, 242, 255, 0.05); border-left: 2px solid var(--n); padding: 10px; margin-bottom: 8px; animation: msgReveal 0.3s ease-out; }
        @keyframes msgReveal { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .msg-nick { font-weight: bold; text-transform: uppercase; }
        input { background: rgba(0,0,0,0.8); border: 1px solid var(--n); color: #fff; padding: 14px; width: 100%; font-family: inherit; outline: none; margin-bottom: 10px; }
        button { background: transparent; color: var(--n); border: 1px solid var(--n); padding: 12px; width: 100%; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 11px; text-transform: uppercase; }
        button:hover { background: var(--n); color: #000; }
        #radar { width: 100%; height: 120px; border: 1px solid var(--n); margin-bottom: 20px; position: relative; overflow: hidden; background: black; }
        #radar-sweep { position: absolute; width: 200%; height: 200%; top: -50%; left: -50%; background: conic-gradient(from 0deg, var(--n) 0deg, transparent 90deg); opacity: 0.2; animation: rotate 4s linear infinite; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body>

<canvas id="canvas-bg"></canvas>

<div class="ui">
    <div class="sidebar">
        <h2>DEEP_SCAN</h2>
        <div id="radar"><div id="radar-sweep"></div></div>
        <h2>LOGS</h2>
        <input type="text" id="todo-in" placeholder="> ENTRY" onkeypress="if(event.key==='Enter') addTodo()">
        <div id="todo-list" style="overflow-y:auto; flex-grow:1;"></div>
        <div style="margin-top: 20px; font-size: 10px; border-top: 1px solid rgba(0,242,255,0.2); padding-top: 10px;">
            <div id="sys-status" style="color:var(--p)">SYSTEM: READY</div>
            <div id="clock">00:00:00</div>
        </div>
    </div>
    <div class="main-content">
        <div class="terminal" id="main-terminal">
            <div id="auth-ui">
                <h2 style="text-align: center;">IDENT_REQUIRED</h2>
                <input type="email" id="email" placeholder="PILOT_ID">
                <input type="password" id="pass" placeholder="PASSWORD">
                <button onclick="auth('in')">LOGIN</button>
                <button onclick="auth('up')" style="margin-top:5px; border-color:var(--p); color:var(--p)">REGISTER</button>
            </div>
            <div id="chat-ui" class="hidden">
                <div id="chat-box"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="msg-in" placeholder="SIGNAL..." onkeypress="if(event.key==='Enter') send()">
                    <button onclick="send()" style="width: 80px;">SEND</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ВНИМАНИЕ: В этом скрипте полностью отсутствуют символы сравнения < и >
(function() {
    const URL = 'https://ebjsxlympwocluxgmwcu.supabase.co';
    const KEY = 'sb_publishable_8HhPj3Y8g5V7Np8Vy5xbzQ_2B7LjTkj';
    const sb = window.supabase.createClient(URL, KEY);

    const getNickColor = (str) => {
        let hash = 0;
        Array.from(str).forEach(char => {
            hash = char.charCodeAt(0) + ((hash << 5) - hash);
        });
        return `hsl(${Math.abs(hash) % 360}, 100%, 75%)`;
    };

    const triggerGlitch = () => {
        const t = document.getElementById('main-terminal');
        if(t) { t.classList.add('glitch-active'); setTimeout(() => t.classList.remove('glitch-active'), 400); }
    };

    window.addTodo = () => {
        const i = document.getElementById('todo-in'); if(!i || !i.value) return;
        const d = document.createElement('div');
        d.className = 'msg'; d.style.fontSize='11px'; d.innerText = '> ' + i.value.toUpperCase();
        d.onclick = function(){ this.remove(); };
        document.getElementById('todo-list').appendChild(d); i.value = '';
    };

    window.auth = async (m) => {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        const { error } = m === 'in' ? await sb.auth.signInWithPassword({email:e, password:p}) : await sb.auth.signUp({email:e, password:p});
        if(error) alert(error.message);
    };

    sb.auth.onAuthStateChange((event, session) => {
        const aUI = document.getElementById('auth-ui'), cUI = document.getElementById('chat-ui');
        if(aUI && cUI) {
            const isS = Boolean(session);
            aUI.classList.toggle('hidden', isS);
            cUI.classList.toggle('hidden', !isS);
            if(isS) { load(true); document.getElementById('sys-status').innerText = "SYSTEM: ONLINE"; }
        }
    });

    async function load(full = false) {
        const { data } = await sb.from('comments').select('*').order('created_at', {ascending: true});
        const b = document.getElementById('chat-box');
        if(full && data && b) { b.innerHTML = ''; data.forEach(appendMsg); b.scrollTop = b.scrollHeight; }
    }

    function appendMsg(m) {
        const b = document.getElementById('chat-box'); if(!b) return;
        const d = document.createElement('div');
        d.className = 'msg';
        const t = m.created_at ? new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "--:--";
        const color = getNickColor(m.nickname || 'Unknown');
        d.innerHTML = '<div><span style="opacity:0.5; font-size:10px;">['+t+']</span> <span class="msg-nick" style="color:'+color+'">'+m.nickname+':</span> '+m.message+'</div>';
        b.appendChild(d); b.scrollTop = b.scrollHeight;
    }

    window.send = async () => {
        const i = document.getElementById('msg-in');
        const { data: { user } } = await sb.auth.getUser();
        if(i && i.value && user) {
            const v = i.value, n = user.email.split('@')[0];
            i.value = ''; appendMsg({nickname:n, message:v});
            await sb.from('comments').insert([{message:v, nickname:n}]);
        }
    };

    sb.channel('chat').on('postgres_changes', {event:'INSERT', schema:'public', table:'comments'}, async (p) => {
        const { data: { user } } = await sb.auth.getUser();
        if(user && user.email.split('@')[0] !== p.new.nickname) { appendMsg(p.new); triggerGlitch(); }
    }).subscribe();

    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    let stars = [], stones = [], astronauts = [], ufo = { x: -100, y: 150 };

    function init() {
        if(!canvas) return;
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        stars = []; stones = []; astronauts = [];
        Array.from({length: 100}).forEach(() => stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*1.5}));
        Array.from({length: 5}).forEach(() => stones.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:0.5, p:[{x:-15,y:-10},{x:15,y:-12},{x:20,y:10},{x:0,y:15},{x:-18,y:8}]}));
        Array.from({length: 2}).forEach(() => astronauts.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, vx:0.2, vy:0.1, rot:0}));
    }

    function drawPlanet() {
        ctx.fillStyle = '#004466'; ctx.beginPath(); ctx.arc(canvas.width*0.8, canvas.height*0.2, 80, 0, 7); ctx.fill();
        ctx.strokeStyle = 'rgba(0,242,255,0.1)'; ctx.beginPath(); ctx.ellipse(canvas.width*0.8, canvas.height*0.2, 200, 40, 0.5, 0, 7); ctx.stroke();
    }

    function drawUFO() {
        ufo.x += 0.7; if(ufo.x > canvas.width + 100) ufo.x = -100;
        let ty = ufo.y + Math.sin(Date.now()/500)*15;
        ctx.fillStyle = '#333'; ctx.beginPath(); ctx.ellipse(ufo.x, ty, 35, 8, 0, 0, 7); ctx.fill();
        ctx.fillStyle = '#0ff'; ctx.beginPath(); ctx.arc(ufo.x, ty-3, 10, 3.1, 0); ctx.fill();
    }

    function loop() {
        ctx.fillStyle = '#01050a'; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.fillStyle = 'white'; stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,7); ctx.fill(); });
        drawPlanet();
        stones.forEach(s => { 
            s.y += s.s; if(s.y > canvas.height + 50) s.y = -50;
            ctx.save(); ctx.translate(s.x, s.y); ctx.fillStyle = '#1a2533'; ctx.beginPath();
            s.p.forEach((p,idx) => idx === 0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y)); ctx.fill(); ctx.restore();
        });
        astronauts.forEach(a => {
            a.x += a.vx; a.y += a.vy; a.rot += 0.01; if(a.x > canvas.width + 50) a.x = -50;
            ctx.save(); ctx.translate(a.x,a.y); ctx.rotate(a.rot); ctx.fillStyle='#eee'; ctx.fillRect(-8,-10,16,20); ctx.restore();
        });
        drawUFO();
        const clk = document.getElementById('clock'); if(clk) clk.innerText = new Date().toLocaleTimeString();
        requestAnimationFrame(loop);
    }
    init(); loop(); window.onresize = init;
})();
</script>
</body>
</html>