<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ORBITRON TERMINAL v8.1</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --n: #00f2ff; --p: #ff00ff; --bg: #01050a; --gl: rgba(5, 15, 25, 0.9); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--n); font-family: 'Share Tech Mono', monospace; height: 100vh; overflow: hidden; cursor: crosshair; }
        
        /* CRT & Scanlines Effect */
        body::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 100; background-size: 100% 3px, 3px 100%; pointer-events: none;
        }
        body::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: radial-gradient(circle, rgba(18, 16, 16, 0) 40%, rgba(0, 0, 0, 0.4) 100%);
            z-index: 101; pointer-events: none;
        }

        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; pointer-events: none; }
        
        .sidebar { width: 320px; height: 100%; background: var(--gl); border-right: 1px solid var(--n); padding: 25px; pointer-events: auto; backdrop-filter: blur(15px); display: flex; flex-direction: column; }
        .main-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        
        .terminal { 
            width: 700px; background: var(--gl); border: 1px solid var(--n); padding: 30px; pointer-events: auto; 
            position: relative; backdrop-filter: blur(10px); box-shadow: 0 0 50px rgba(0,242,255,0.1); 
        }

        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-5px, 3px); filter: hue-rotate(90deg); } 100% { transform: translate(0); } }
        .glitch-active { animation: glitch 0.3s linear; }

        #chat-box { height: 400px; overflow-y: auto; margin-bottom: 20px; display: flex; flex-direction: column; }
        .msg { border-left: 2px solid var(--n); padding: 8px 12px; margin-bottom: 10px; font-size: 14px; background: rgba(0,242,255,0.02); }
        
        .todo-item { padding: 10px; border-bottom: 1px solid rgba(0,242,255,0.1); cursor: pointer; font-size: 12px; transition: 0.2s; }
        .todo-item:hover { color: var(--p); background: rgba(255,0,255,0.05); }

        input { background: rgba(0,0,0,0.7); border: 1px solid var(--n); color: #fff; padding: 12px; width: 100%; font-family: inherit; outline: none; margin-bottom: 10px; border-radius: 0; }
        button { background: transparent; color: var(--n); border: 1px solid var(--n); padding: 10px; cursor: pointer; font-family: 'Orbitron'; text-transform: uppercase; transition: 0.3s; }
        button:hover { background: var(--n); color: #000; }

        .sys-graph { height: 40px; width: 100%; border-bottom: 1px solid rgba(0,242,255,0.3); margin-bottom: 20px; display: flex; align-items: flex-end; gap: 2px; }
        .graph-bar { width: 4px; background: var(--n); animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { height: 10%; } to { height: 90%; } }

        .hidden { display: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--n); }
    </style>
</head>
<body>

<canvas id="canvas-bg"></canvas>

<div class="ui-layer">
    <div class="sidebar">
        <h2 style="font-family:'Orbitron'; font-size:10px; color:var(--p); margin-bottom:15px;">SIGNAL_STRENGTH</h2>
        <div class="sys-graph" id="signal-graph"></div>
        
        <h2 style="font-family:'Orbitron'; font-size:10px; color:var(--p); margin-bottom:10px;">MISSION_LOGS</h2>
        <input type="text" id="todo-in" placeholder="> TYPE ENTRY...">
        <div id="todo-list" style="flex-grow:1; overflow-y:auto;"></div>
        
        <div style="margin-top:20px; font-size:10px; opacity:0.6;">
            <div id="clock">00:00:00</div>
            <div>COORDS: <span id="coords">0.0, 0.0</span></div>
        </div>
    </div>

    <div class="main-area">
        <div class="terminal" id="main-terminal">
            <div id="auth-ui">
                <h1 style="text-align:center; margin-bottom:20px; font-family:'Orbitron'; font-size:16px;">ENCRYPTED_LINK_REQUIRED</h1>
                <input type="email" id="email" placeholder="PILOT_ID">
                <input type="password" id="pass" placeholder="ACCESS_KEY">
                <button onclick="handleAuth('in')" style="width:100%;">CONNECT</button>
                <button onclick="handleAuth('up')" style="width:100%; margin-top:10px; border-color:var(--p); color:var(--p);">REGISTER</button>
            </div>
            
            <div id="chat-ui" class="hidden">
                <div id="chat-box"></div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="msg-in" placeholder="SIGNAL DATA..." onkeypress="if(event.key==='Enter') sendMsg()">
                    <button onclick="sendMsg()" style="width:100px;">SEND</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const URL = 'https://ebjsxlympwocluxgmwcu.supabase.co';
    const KEY = 'sb_publishable_8HhPj3Y8g5V7Np8Vy5xbzQ_2B7LjTkj';
    const sb = window.supabase.createClient(URL, KEY);

    // --- MOUSE TRACKING & INTERACTION ---
    const mouse = { x: 0, y: 0, targetX: 0, targetY: 0 };
    window.addEventListener('mousemove', (e) => {
        mouse.targetX = (e.clientX - window.innerWidth / 2) / 40;
        mouse.targetY = (e.clientY - window.innerHeight / 2) / 40;
        document.getElementById('coords').innerText = e.clientX + ', ' + e.clientY;
    });

    // --- TODO LOGIC (FIXED) ---
    const todoIn = document.getElementById('todo-in');
    const todoList = document.getElementById('todo-list');
    todoIn.addEventListener('keypress', (e) => {
        if(e.key === 'Enter' && todoIn.value) {
            const d = document.createElement('div'); d.className = 'todo-item';
            d.innerText = '> ' + todoIn.value.toUpperCase();
            d.onclick = () => d.remove();
            todoList.prepend(d); todoIn.value = '';
        }
    });

    // --- CHAT LOGIC (FIXED SCROLL) ---
    window.handleAuth = async (t) => {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        const { error } = t === 'in' ? await sb.auth.signInWithPassword({email:e, password:p}) : await sb.auth.signUp({email:e, password:p});
        if(error) alert(error.message);
    };

    sb.auth.onAuthStateChange((_, s) => {
        document.getElementById('auth-ui').classList.toggle('hidden', !!s);
        document.getElementById('chat-ui').classList.toggle('hidden', !s);
        if(s) loadMessages(true); // true для мгновенного скролла
    });

    async function loadMessages(instant = false) {
        const { data } = await sb.from('comments').select('*').order('created_at', {ascending: true});
        if(data) {
            const b = document.getElementById('chat-box');
            b.innerHTML = '';
            data.forEach(m => renderMsg(m, false));
            b.scrollTo({ top: b.scrollHeight, behavior: instant ? 'auto' : 'smooth' });
        }
    }

    function renderMsg(m, scroll = true) {
        const b = document.getElementById('chat-box');
        const d = document.createElement('div'); d.className = 'msg';
        const nick = m.nickname || 'Unknown';
        d.innerHTML = `<span style="color:#0ff; font-weight:bold; font-size:10px;">[${nick.toUpperCase()}]</span><br>${m.message}`;
        b.appendChild(d);
        if(scroll) b.scrollTo({ top: b.scrollHeight, behavior: 'smooth' });
    }

    window.sendMsg = async () => {
        const i = document.getElementById('msg-in');
        if(!i.value) return;

        // Command Parser
        if(i.value.startsWith('/')) {
            const cmd = i.value.toLowerCase();
            if(cmd === '/clear') document.getElementById('chat-box').innerHTML = '';
            if(cmd === '/status') renderMsg({nickname: 'SYSTEM', message: 'ALL SYSTEMS NOMINAL. O2: 98%'});
            if(cmd === '/glitch') {
                document.getElementById('main-terminal').classList.add('glitch-active');
                setTimeout(() => document.getElementById('main-terminal').classList.remove('glitch-active'), 500);
            }
            i.value = ''; return;
        }

        const { data: { user } } = await sb.auth.getUser();
        if(user) {
            const n = user.email.split('@')[0], v = i.value;
            i.value = ''; renderMsg({nickname:n, message:v});
            await sb.from('comments').insert([{message:v, nickname:n}]);
        }
    };

    // --- ENGINE: PARALLAX & INTERACTIVE COSMOS ---
    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    let stars = [], stones = [], astronauts = [], ufo = { x: -200, y: 250, fast: false };

    function init() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        stars = Array.from({length: 150}, () => ({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*1.2, p:Math.random()*2}));
        stones = Array.from({length: 6}, () => ({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: 0.4 + Math.random(),
            pts: Array.from({length:7}, (_,i) => ({x:Math.cos(i)*15+Math.random()*5, y:Math.sin(i)*15+Math.random()*5}))
        }));
        astronauts = Array.from({length: 2}, () => ({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: 0.2, vy: 0.1, r: Math.random()*6, status: 'DRIFTING'
        }));
        
        // Виджет графика
        const g = document.getElementById('signal-graph');
        g.innerHTML = '';
        Array.from({length: 40}).forEach(() => {
            const b = document.createElement('div'); b.className = 'graph-bar';
            b.style.animationDelay = Math.random() + 's';
            g.appendChild(b);
        });
    }

    window.addEventListener('mousedown', (e) => {
        // Проверка клика по НЛО
        let uy = ufo.y + Math.sin(Date.now()/400)*20;
        let dist = Math.hypot(e.clientX - ufo.x, e.clientY - uy);
        if(dist < 50) ufo.fast = !ufo.fast;
    });

    function draw() {
        mouse.x += (mouse.targetX - mouse.x) * 0.05;
        mouse.y += (mouse.targetY - mouse.y) * 0.05;

        ctx.fillStyle = '#01050a'; ctx.fillRect(0,0,canvas.width, canvas.height);
        
        // Stars with Parallax
        stars.forEach(s => {
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.beginPath(); 
            ctx.arc(s.x + mouse.x * s.p, s.y + mouse.y * s.p, s.r, 0, 7); 
            ctx.fill();
        });

        // Planet with Parallax
        const px = canvas.width*0.8 + mouse.x * 0.5, py = canvas.height*0.2 + mouse.y * 0.5;
        let grad = ctx.createRadialGradient(px-20, py-20, 5, px, py, 60);
        grad.addColorStop(0, '#005577'); grad.addColorStop(1, '#000a15');
        ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(px, py, 60, 0, 7); ctx.fill();
        ctx.strokeStyle = 'rgba(0,242,255,0.1)'; ctx.beginPath(); ctx.ellipse(px, py, 140, 30, 0.4, 0, 7); ctx.stroke();

        // Interactive Astronauts
        astronauts.forEach(a => {
            a.x += a.vx; a.y += a.vy; a.r += 0.005;
            if(a.x > canvas.width + 100) a.x = -100;
            
            ctx.save(); ctx.translate(a.x, a.y); ctx.rotate(a.r);
            // Hover check
            let isHover = Math.hypot(mouse.targetX*40 + window.innerWidth/2 - a.x, mouse.targetY*40 + window.innerHeight/2 - a.y) < 40;
            
            ctx.fillStyle = '#fff';
            ctx.beginPath(); ctx.arc(0, -10, 7, 0, 7); ctx.fill(); // Head
            ctx.roundRect(-6, -5, 12, 14, 3); ctx.fill(); // Body
            ctx.fillStyle = '#111'; ctx.fillRect(-4, -12, 8, 4); // Visor
            
            if(isHover) {
                ctx.rotate(-a.r);
                ctx.fillStyle = var_n = '#0ff'; ctx.font = '10px Orbitron';
                ctx.fillText('STATUS: ' + a.status, 15, -10);
                ctx.fillText('O2: 84%', 15, 2);
            }
            ctx.restore();
        });

        // Interactive UFO
        ufo.x += ufo.fast ? 4 : 1.2; 
        if(ufo.x > canvas.width + 200) ufo.x = -200;
        let uy = ufo.y + Math.sin(Date.now()/(ufo.fast?200:400))*20;
        
        ctx.fillStyle = ufo.fast ? '#500' : '#222';
        ctx.beginPath(); ctx.ellipse(ufo.x, uy, 45, 12, 0, 0, 7); ctx.fill();
        ctx.fillStyle = ufo.fast ? 'rgba(255,0,0,0.4)' : 'rgba(0,242,255,0.4)';
        ctx.beginPath(); ctx.arc(ufo.x, uy-4, 15, 3.14, 0); ctx.fill();
        
        // Lights
        for(let i=-2; i<=2; i++) {
            ctx.fillStyle = (Math.floor(Date.now()/(ufo.fast?100:300)) % 2 === Math.abs(i)%2) ? (ufo.fast?'#f00':'#0ff') : '#111';
            ctx.beginPath(); ctx.arc(ufo.x + i*18, uy+3, 3, 0, 7); ctx.fill();
        }

        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        requestAnimationFrame(draw);
    }

    init(); draw(); window.onresize = init;
})();
</script>
</body>
</html>