<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORBITRON TERMINAL v7.7</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --n: #00f2ff; --p: #ff00ff; --bg: #01050a; --gl: rgba(5, 15, 25, 0.9); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--n); font-family: 'Share Tech Mono', monospace; height: 100vh; overflow: hidden; }
        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; pointer-events: none; }
        .sidebar { width: 320px; height: 100%; background: var(--gl); border-right: 1px solid var(--n); padding: 30px; pointer-events: auto; backdrop-filter: blur(15px); display: flex; flex-direction: column; }
        .main-terminal-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .terminal-box { width: 650px; background: var(--gl); border: 1px solid var(--n); padding: 30px; pointer-events: auto; position: relative; backdrop-filter: blur(12px); border-radius: 4px; box-shadow: 0 0 30px rgba(0,242,255,0.1); }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-4px, 2px); filter: hue-rotate(45deg); } 100% { transform: translate(0); } }
        .glitch-active { animation: glitch 0.2s linear 2; }
        #chat-box { height: 400px; overflow-y: auto; margin-bottom: 20px; display: flex; flex-direction: column; }
        .msg { background: rgba(0, 242, 255, 0.05); border-left: 2px solid var(--n); padding: 10px; margin-bottom: 8px; }
        input { background: rgba(0,0,0,0.8); border: 1px solid var(--n); color: #fff; padding: 12px; width: 100%; font-family: inherit; outline: none; margin-bottom: 10px; }
        button { background: transparent; color: var(--n); border: 1px solid var(--n); padding: 10px; width: 100%; cursor: pointer; font-family: 'Orbitron'; text-transform: uppercase; margin-bottom: 5px; }
        button:hover { background: var(--n); color: #000; }
        #radar { width: 100%; height: 120px; border: 1px solid var(--n); margin-bottom: 20px; position: relative; overflow: hidden; background: #000; }
        #radar-sweep { position: absolute; width: 200%; height: 200%; top: -50%; left: -50%; background: conic-gradient(from 0deg, var(--n) 0deg, transparent 90deg); opacity: 0.2; animation: rot 4s linear infinite; }
        @keyframes rot { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body>

<canvas id="canvas-bg"></canvas>

<div class="ui-layer">
    <div class="sidebar">
        <h2 style="font-family:'Orbitron'; font-size: 14px; margin-bottom:10px;">DEEP_SCAN</h2>
        <div id="radar"><div id="radar-sweep"></div></div>
        <h2 style="font-family:'Orbitron'; font-size: 14px; margin-bottom:10px;">LOGS</h2>
        <div id="todo-list" style="overflow-y:auto; flex-grow:1; font-size:11px;"></div>
        <div style="margin-top: 10px; border-top: 1px solid rgba(0,242,255,0.2); padding-top:10px; font-size:10px;">
            <div id="sys-status" style="color:var(--p)">SYSTEM: READY</div>
            <div id="clock">00:00:00</div>
        </div>
    </div>
    
    <div class="main-terminal-area">
        <div class="terminal-box" id="main-terminal">
            <div id="auth-ui">
                <h2 style="text-align: center; margin-bottom: 20px; font-family: 'Orbitron';">IDENT_REQUIRED</h2>
                <input type="email" id="email" placeholder="PILOT_ID">
                <input type="password" id="pass" placeholder="PASSWORD">
                <button onclick="handleAuth('in')">LOGIN</button>
                <button onclick="handleAuth('up')" style="border-color:var(--p); color:var(--p)">REGISTER</button>
            </div>
            
            <div id="chat-ui" class="hidden">
                <div id="chat-box"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="msg-in" placeholder="TYPE SIGNAL..." onkeypress="if(event.key==='Enter') sendMsg()">
                    <button onclick="sendMsg()" style="width: 100px;">SEND</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Весь JS вынесен вниз и написан максимально просто
(function() {
    const URL = 'https://ebjsxlympwocluxgmwcu.supabase.co';
    const KEY = 'sb_publishable_8HhPj3Y8g5V7Np8Vy5xbzQ_2B7LjTkj';
    const sb = window.supabase.createClient(URL, KEY);

    // Функция для цвета ника
    window.getNickColor = (s) => {
        let h = 0;
        for(let i=0; i<s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
        return 'hsl(' + (Math.abs(h) % 360) + ', 100%, 75%)';
    };

    window.handleAuth = async (type) => {
        const e = document.getElementById('email').value;
        const p = document.getElementById('pass').value;
        const { error } = type === 'in' 
            ? await sb.auth.signInWithPassword({email: e, password: p}) 
            : await sb.auth.signUp({email: e, password: p});
        if(error) alert(error.message);
    };

    sb.auth.onAuthStateChange((event, session) => {
        const isAuth = !!session;
        document.getElementById('auth-ui').classList.toggle('hidden', isAuth);
        document.getElementById('chat-ui').classList.toggle('hidden', !isAuth);
        if(isAuth) {
            document.getElementById('sys-status').innerText = "SYSTEM: ONLINE";
            loadMessages();
        }
    });

    async function loadMessages() {
        const { data } = await sb.from('comments').select('*').order('created_at', {ascending: true});
        if(data) {
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            data.forEach(m => renderMessage(m));
            box.scrollTop = box.scrollHeight;
        }
    }

    function renderMessage(m) {
        const box = document.getElementById('chat-box');
        const d = document.createElement('div');
        d.className = 'msg';
        const nick = m.nickname || 'Unknown';
        const color = getNickColor(nick);
        d.innerHTML = '<span style="color:'+color+'; font-weight:bold;">'+nick+':</span> ' + m.message;
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
    }

    window.sendMsg = async () => {
        const input = document.getElementById('msg-in');
        const { data: { user } } = await sb.auth.getUser();
        if(input.value && user) {
            const nick = user.email.split('@')[0];
            const msg = input.value;
            input.value = '';
            await sb.from('comments').insert([{message: msg, nickname: nick}]);
            // Локально отрисуем сразу для скорости
            renderMessage({nickname: nick, message: msg});
        }
    };

    // Подписка на новые сообщения
    sb.channel('public:comments').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments' }, payload => {
        sb.auth.getUser().then(({data}) => {
            if(data.user && data.user.email.split('@')[0] !== payload.new.nickname) {
                renderMessage(payload.new);
                const t = document.getElementById('main-terminal');
                t.classList.add('glitch-active');
                setTimeout(() => t.classList.remove('glitch-active'), 300);
            }
        });
    }).subscribe();

    // --- GRAPHICS ENGINE ---
    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    let stars = [], stones = [], astronauts = [], ufo = { x: -100, y: 150 };

    function init() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        stars = Array.from({length: 80}, () => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*1.5}));
        stones = Array.from({length: 5}, () => ({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height, 
            s: 0.2 + Math.random()*0.4, 
            p: [{x:-15,y:-10}, {x:15,y:-12}, {x:20,y:10}, {x:0,y:15}, {x:-18,y:8}]
        }));
        astronauts = Array.from({length: 2}, () => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: 0.2, vy: 0.1, r: 0}));
    }

    function draw() {
        ctx.fillStyle = '#01050a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Stars
        ctx.fillStyle = '#fff';
        stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, 7); ctx.fill(); });

        // Planet
        ctx.fillStyle = '#004466'; ctx.beginPath(); ctx.arc(canvas.width*0.8, canvas.height*0.2, 70, 0, 7); ctx.fill();
        ctx.strokeStyle = 'rgba(0,242,255,0.2)'; ctx.beginPath(); ctx.ellipse(canvas.width*0.8, canvas.height*0.2, 180, 40, 0.5, 0, 7); ctx.stroke();

        // Stones
        stones.forEach(s => {
            s.y += s.s; if(s.y > canvas.height + 50) s.y = -50;
            ctx.save(); ctx.translate(s.x, s.y); ctx.fillStyle = '#1a2533'; ctx.beginPath();
            s.p.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
            ctx.fill(); ctx.restore();
        });

        // Astronauts
        astronauts.forEach(a => {
            a.x += a.vx; a.y += a.vy; a.r += 0.01; if(a.x > canvas.width + 50) a.x = -50;
            ctx.save(); ctx.translate(a.x, a.y); ctx.rotate(a.r);
            ctx.fillStyle = '#eee'; ctx.fillRect(-8, -10, 16, 20); // body
            ctx.fillStyle = '#333'; ctx.fillRect(-5, -7, 10, 5);   // visor
            ctx.restore();
        });

        // UFO
        ufo.x += 0.7; if(ufo.x > canvas.width + 100) ufo.x = -100;
        let uy = ufo.y + Math.sin(Date.now()/500)*15;
        ctx.fillStyle = '#222'; ctx.beginPath(); ctx.ellipse(ufo.x, uy, 35, 8, 0, 0, 7); ctx.fill();
        ctx.fillStyle = 'rgba(0,242,255,0.5)'; ctx.beginPath(); ctx.arc(ufo.x, uy-3, 10, 3.14, 0); ctx.fill();

        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        requestAnimationFrame(draw);
    }

    window.addEventListener('resize', init);
    init();
    draw();
})();
</script>
</body>
</html>