<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Command Center v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --neon: #00f2ff; --pink: #ff00ff; --glass: rgba(10, 25, 41, 0.85); }
        body { margin: 0; background: #020205; color: var(--neon); font-family: 'Courier New', monospace; overflow: hidden; display: flex; height: 100vh; }
        
        #canvas-bg { position: fixed; top: 0; left: 0; z-index: -1; }

        .sidebar { width: 320px; background: var(--glass); border-right: 1px solid var(--neon); padding: 25px; backdrop-filter: blur(15px); display: flex; flex-direction: column; z-index: 10; box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5); }
        .main-hub { flex-grow: 1; display: flex; justify-content: center; align-items: center; z-index: 10; }

        .container { background: var(--glass); border: 1px solid var(--neon); box-shadow: 0 0 50px rgba(0, 242, 255, 0.2); padding: 30px; border-radius: 5px; width: 480px; position: relative; }
        .container::before { content: ""; position: absolute; top: -2px; left: -2px; right: -2px; height: 10px; background: var(--neon); clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%); }

        #chat-box { height: 420px; overflow-y: auto; margin-bottom: 20px; padding-right: 10px; border-bottom: 1px solid rgba(0, 242, 255, 0.2); }
        .msg { margin-bottom: 15px; padding: 12px; background: rgba(0, 242, 255, 0.03); border-left: 2px solid var(--pink); position: relative; }
        .msg-author { font-size: 0.8em; color: var(--pink); text-transform: uppercase; letter-spacing: 1px; }
        .msg-text { color: #e0faff; margin-top: 5px; line-height: 1.4; }

        .todo-item { background: rgba(255, 255, 255, 0.03); padding: 10px; margin: 8px 0; border: 1px solid rgba(0, 242, 255, 0.2); display: flex; justify-content: space-between; font-size: 0.85em; transition: 0.3s; }
        .todo-item:hover { background: rgba(0, 242, 255, 0.1); border-color: var(--neon); }

        input { background: rgba(0, 0, 0, 0.7); border: 1px solid var(--neon); color: #fff; padding: 12px; margin-bottom: 10px; width: calc(100% - 26px); outline: none; }
        button { width: 100%; padding: 15px; background: transparent; color: var(--neon); border: 1px solid var(--neon); cursor: pointer; font-weight: bold; letter-spacing: 2px; transition: 0.3s; position: relative; overflow: hidden; }
        button:hover { background: var(--neon); color: #000; box-shadow: 0 0 20px var(--neon); }
        
        .hidden { display: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--neon); }
    </style>
</head>
<body>

<canvas id="canvas-bg"></canvas>

<div class="sidebar">
    <h2 style="letter-spacing: 4px; border-bottom: 1px solid var(--neon); padding-bottom: 10px;">MISSION LOG</h2>
    <div id="todo-list" style="margin-top: 20px;">
        <input type="text" id="todo-input" placeholder="+ ADD OBJECTIVE" style="width: 85%; font-size: 0.7em;">
        <div class="todo-item"><span>STABILIZE CORE</span><span style="color: var(--pink);">[!]</span></div>
        <div class="todo-item"><span>DOCKING COMPLETE</span><span style="color: #0f0;">[OK]</span></div>
    </div>
    <div style="margin-top: auto; font-size: 0.7em; line-height: 2;">
        STATUS: <span style="color: #0f0;">CONNECTED</span><br>
        SECTOR: X-99<br>
        HULL: 100%
    </div>
</div>

<div class="main-hub">
    <div class="container">
        <div id="auth-screen">
            <h1 style="text-align: center; font-size: 1.5em; letter-spacing: 5px;">ACCESS GATE</h1>
            <input type="email" id="email" placeholder="PILOT EMAIL">
            <input type="password" id="password" placeholder="SECURITY CODE">
            <button onclick="handleSignIn()">LOGIN</button>
            <button onclick="handleSignUp()" style="margin-top:10px; border-color: var(--pink); color: var(--pink);">REGISTER</button>
        </div>

        <div id="chat-screen" class="hidden">
            <div id="chat-box"></div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="msg-input" placeholder="SEND SIGNAL...">
                <button onclick="sendMessage()" style="width: 80px;">>>></button>
            </div>
            <button onclick="handleSignOut()" style="margin-top: 15px; font-size: 0.6em; border-color: #ff4d4d; color: #ff4d4d;">DISCONNECT</button>
        </div>
    </div>
</div>

<script>
    const G_URL = 'https://ebjsxlympwocluxgmwcu.supabase.co';
    const G_KEY = 'sb_publishable_8HhPj3Y8g5V7Np8Vy5xbzQ_2B7LjTkj';
    const sb = window.supabase.createClient(G_URL, G_KEY);

    const authScreen = document.getElementById('auth-screen');
    const chatScreen = document.getElementById('chat-screen');
    const chatBox = document.getElementById('chat-box');

    sb.auth.onAuthStateChange((event, session) => {
        if (session) {
            authScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
            loadMessages();
            subscribe();
        } else {
            authScreen.classList.remove('hidden');
            chatScreen.classList.add('hidden');
        }
    });

    async function handleSignUp() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        const { error } = await sb.auth.signUp({ email: e, password: p });
        if (error) alert(error.message); else alert("Pilot registered!");
    }

    async function handleSignIn() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        const { error } = await sb.auth.signInWithPassword({ email: e, password: p });
        if (error) alert(error.message);
    }

    async function handleSignOut() { await sb.auth.signOut(); }

    async function loadMessages() {
        const { data } = await sb.from('comments').select('*').order('created_at', { ascending: true });
        chatBox.innerHTML = '';
        if(data) data.forEach(msg => render(msg));
    }

    function render(msg) {
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<div class="msg-author">PILOT_${msg.nickname || 'Unknown'}</div><div class="msg-text">${msg.message}</div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('msg-input');
        const { data: { user } } = await sb.auth.getUser();
        if (input.value.trim() && user) {
            await sb.from('comments').insert([{ message: input.value, nickname: user.email.split('@')[0] }]);
            input.value = '';
        }
    }

    function subscribe() {
        sb.channel('chat').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments' }, p => render(p.new)).subscribe();
    }

    // --- COSMIC ENGINE ---
    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    let stars = [], asteroids = [];
    let ufo = { x: -200, y: 100, speed: 2, angle: 0 };

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize; resize();

    for(let i=0; i<1000; i++) {
        stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*1.2, o: Math.random() });
    }

    for(let i=0; i<15; i++) {
        asteroids.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*15+5, s: Math.random()*2+1, rot: 0, rs: Math.random()*0.05 });
    }

    function drawPlanet(x, y, r, color, ring) {
        ctx.shadowBlur = 40; ctx.shadowColor = color;
        let g = ctx.createRadialGradient(x-r/3, y-r/3, r/10, x, y, r);
        g.addColorStop(0, '#fff'); g.addColorStop(0.2, color); g.addColorStop(1, '#000');
        ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
        if(ring) {
            ctx.strokeStyle = "rgba(255,255,255,0.2)";
            ctx.lineWidth = 10;
            ctx.beginPath(); ctx.ellipse(x, y, r*2, r*0.4, Math.PI/6, 0, Math.PI*2); ctx.stroke();
        }
    }

    function drawUFO() {
        ufo.x += ufo.speed; ufo.angle += 0.05; ufo.y += Math.sin(ufo.angle)*1;
        if(ufo.x > canvas.width + 300) ufo.x = -300;

        ctx.fillStyle = "#777"; // Корпус
        ctx.beginPath(); ctx.ellipse(ufo.x, ufo.y, 40, 12, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "rgba(0, 242, 255, 0.4)"; // Купол
        ctx.beginPath(); ctx.arc(ufo.x, ufo.y-5, 15, Math.PI, 0); ctx.fill();
        ctx.fillStyle = (Math.floor(Date.now()/200)%2) ? "#0f0" : "#f00"; // Мигалки
        ctx.beginPath(); ctx.arc(ufo.x-20, ufo.y, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(ufo.x+20, ufo.y, 2, 0, Math.PI*2); ctx.fill();
    }

    function draw() {
        ctx.fillStyle = "#020205"; ctx.fillRect(0,0,canvas.width, canvas.height);
        
        stars.forEach(s => {
            ctx.fillStyle = `rgba(255,255,255,${s.o})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
        });

        drawPlanet(canvas.width*0.8, canvas.height*0.2, 60, "#ff3300", true);
        drawPlanet(canvas.width*0.2, canvas.height*0.8, 40, "#0066ff", false);

        ctx.fillStyle = "#444";
        asteroids.forEach(a => {
            a.y += a.s; a.rot += a.rs;
            if(a.y > canvas.height + 50) a.y = -50;
            ctx.save(); ctx.translate(a.x, a.y); ctx.rotate(a.rot);
            ctx.fillRect(-a.r/2, -a.r/2, a.r, a.r); ctx.restore();
        });

        drawUFO();
        requestAnimationFrame(draw);
    }
    draw();

    document.getElementById('todo-input').addEventListener('keypress', (e) => {
        if(e.key === 'Enter' && e.target.value) {
            const div = document.createElement('div');
            div.className = 'todo-item';
            div.innerHTML = `<span>${e.target.value.toUpperCase()}</span><span style="color:var(--neon)">[WAIT]</span>`;
            document.getElementById('todo-list').prepend(div);
            e.target.value = '';
        }
    });
</script>
</body>
</html>