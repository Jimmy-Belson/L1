<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ORBITRON v10.1_STATION</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --n: #00f2ff; --p: #ff00ff; --bg: #01050a; --glass: rgba(0, 242, 255, 0.05); --border: rgba(0, 242, 255, 0.2); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--n); font-family: 'Share Tech Mono', monospace; height: 100vh; overflow: hidden; }
        #starfield { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .os-container { position: relative; z-index: 10; display: flex; flex-direction: column; height: 100vh; padding: 20px; pointer-events: none; }
        header, .panel { pointer-events: all; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border); margin-bottom: 20px; font-family: 'Orbitron'; background: rgba(1,5,10,0.5); }
        .main-area { display: flex; flex: 1; gap: 40px; overflow: hidden; }
        .panel { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid var(--border); display: flex; flex-direction: column; box-shadow: 0 0 40px #000; position: relative; z-index: 20; }
        
        /* TODO PANEL - Возвращена полная высота */
        .todo-panel { width: 300px; flex-shrink: 0; height: 100%; }
        #todo-list { flex: 1; overflow-y: auto; padding: 10px; scrollbar-width: none; }
        .task { padding: 12px; border-bottom: 1px solid rgba(0,242,255,0.1); cursor: pointer; transition: 0.2s; font-size: 13px; }
        .task:hover { color: var(--p); background: rgba(255,0,255,0.1); text-decoration: line-through; }
        
        /* CHAT WRAPPER - Центровка чата по вертикали и горизонтали */
        .chat-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .chat-panel { width: 100%; max-width: 550px; height: 550px; pointer-events: all; }
        
        #chat-stream { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scrollbar-width: none; }
        .msg-container { animation: msgAppear 0.4s cubic-bezier(0.18,0.89,0.32,1.28) forwards; opacity: 0; transform: translateY(20px); }
        
        /* НИКИ - Сделаны максимально жирными для стиля */
        .msg-nick { font-size: 11px; color: var(--n); margin-bottom: 4px; font-family: 'Orbitron'; font-weight: 900; text-shadow: 0 0 8px var(--n); }
        .msg-text { background: rgba(0,242,255,0.08); padding: 12px 16px; border-radius: 2px 12px 12px 12px; border: 1px solid rgba(0,242,255,0.1); color: #fff; }
        
        .input-box { display: flex; gap: 10px; padding: 15px; background: rgba(0,0,0,0.4); border-top: 1px solid var(--border); position: relative; z-index: 30; }
        input { background: rgba(0,0,0,0.6); border: 1px solid var(--border); color: #fff; padding: 12px; flex: 1; outline: none; }
        button { background: transparent; border: 1px solid var(--n); color: var(--n); padding: 10px 20px; cursor: pointer; font-family: 'Orbitron'; font-size: 11px; transition: 0.3s; z-index: 40; position: relative; }
        button:hover { background: var(--n); color: #000; box-shadow: 0 0 15px var(--n); }
        
        #auth-gate { position: fixed; inset: 0; z-index: 500; background: radial-gradient(circle at center, #0a121a 0%, #01050a 100%); display: flex; align-items: center; justify-content: center; }
        .auth-form { width: 380px; padding: 40px; background: rgba(1, 5, 10, 0.8); border: 1px solid var(--border); box-shadow: 0 0 60px rgba(0,0,0,1); text-align: center; }
        .auth-input-group { margin-bottom: 25px; text-align: left; }
        .auth-input-group label { font-size: 10px; color: var(--p); display: block; margin-bottom: 8px; font-family: 'Orbitron'; }
        .auth-form input { width: 100%; background: rgba(0, 242, 255, 0.05); border: 1px solid var(--border); padding: 12px; color: #fff; outline: none; }
        .login-btn { width: 100%; padding: 16px; background: transparent; border: 1px solid var(--n); color: var(--n); font-family: 'Orbitron'; cursor: pointer; transition: 0.3s; margin-bottom: 10px; }
        .login-btn:hover { background: var(--n); color: #000; box-shadow: 0 0 20px var(--n); }
        .hidden { display: none !important; }
        .audio-link { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 5px 12px; border: 1px solid var(--border); font-size: 10px; }
        .bars { display: flex; align-items: flex-end; gap: 2px; height: 15px; }
        .bar { width: 2px; height: 4px; background: var(--n); }
        .playing .bar { animation: wave 0.5s infinite alternate; }
        @keyframes wave { from { height: 4px; } to { height: 15px; background: var(--p); } }
        @keyframes msgAppear { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
<canvas id="starfield"></canvas>
<div id="auth-gate">
    <div class="auth-form">
        <h1 style="font-family:'Orbitron'; color:var(--n); margin-bottom:20px; font-size:20px">STATION_LOGIN</h1>
        <div class="auth-input-group">
            <label>YOUR_MAIL</label>
            <input type="email" id="email" placeholder="---" autocomplete="off">
        </div>
        <div class="auth-input-group">
            <label>YOUR_PASSWORD</label>
            <input type="password" id="pass" placeholder="---">
        </div>
        <button class="login-btn" onclick="Core.Auth()">INITIATE_SESSION</button>
        <button class="login-btn" onclick="Core.Register()" style="border-color: var(--p); color: var(--p);">CREATE_NEW_PILOT</button>
    </div>
</div>

<div class="os-container">
    <header>
        <div>ORBITRON_OS v10.1</div>
        <div id="clock">00:00:00</div>
        <div class="audio-link" id="audio-btn" onclick="Core.Audio.toggle()">
            <div class="bars"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
            <span>LINK_AUDIO</span>
        </div>
    </header>
    <div class="main-area">
        <aside class="panel todo-panel">
            <div style="padding:15px; font-size:10px; border-bottom:1px solid var(--border); font-family:'Orbitron'">MISSION_LOGS</div>
            <div class="input-box"><input type="text" id="todo-in" placeholder="..."></div>
            <div id="todo-list"></div>
        </aside>
        <div class="chat-wrapper">
            <main class="panel chat-panel">
                <div id="chat-stream"></div>
                <div class="input-box">
                    <input type="text" id="chat-in" placeholder="TYPE_MESSAGE...">
                    <button id="send-btn" onclick="Core.Chat.send()">SEND</button>
                </div>
            </main>
        </div>
    </div>
</div>

<script>
const Core = {
    sb: window.supabase.createClient('https://ebjsxlympwocluxgmwcu.supabase.co', 'sb_publishable_8HhPj3Y8g5V7Np8Vy5xbzQ_2B7LjTkj'),
    user: null,
    
    init() {
        this.Canvas.init(); 
        this.Audio.setup(); 
        this.UI();
        
        // Часы
        setInterval(() => {
            const el = document.getElementById('clock');
            if(el) el.innerText = new Date().toLocaleTimeString('ru-RU', { hour12: false });
        }, 1000);

        // Слушаем авторизацию
        this.sb.auth.onAuthStateChange((event, session) => { 
            if (session) { 
                this.user = session.user; 
                document.getElementById('auth-gate').classList.add('hidden'); 
                
                // Сначала загружаем историю, потом включаем живой эфир
                this.Chat.load().then(() => {
                    this.Chat.subscribe(); 
                });
            }
        });
        this.loop();
    },

    Chat: {
        async load() { 
            const { data, error } = await Core.sb.from('comments').select('*').order('created_at', {ascending:true}); 
            if(data) { 
                document.getElementById('chat-stream').innerHTML = ''; 
                data.forEach(m => this.render(m)); 
            } 
        },
        
        subscribe() {
            // Создаем канал и слушаем ВСЕ изменения в таблице comments
            const channel = Core.sb.channel('realtime_chat')
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'comments' 
                }, (payload) => {
                    console.log("Пришло новое сообщение:", payload.new);
                    this.render(payload.new);
                })
                .subscribe((status) => {
                    console.log("Статус подключения к эфиру:", status);
                });
        },

        render(m) { 
            const s = document.getElementById('chat-stream');
            
            // Если сообщение с таким ID уже есть на экране, не дублируем его
            if (m.id && document.getElementById(`msg-${m.id}`)) return;

            const d = document.createElement('div'); 
            d.className = 'msg-container';
            if (m.id) d.id = `msg-${m.id}`;
            
            const time = new Date(m.created_at || Date.now()).toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit', hour12:false});
            d.innerHTML = `
                <div class="msg-nick" style="font-weight:900; text-shadow: 0 0 10px var(--n);">
                    ${(m.nickname||'PILOT').toUpperCase()} 
                    <span style="opacity:0.4; font-size:9px; margin-left:10px; color:#fff; font-weight:400;">${time}</span>
                </div>
                <div class="msg-text">${m.message}</div>
            `; 
            s.appendChild(d); 
            s.scrollTop = s.scrollHeight;
        },

        async send() { 
            const i = document.getElementById('chat-in'); 
            if(!i.value || !Core.user) return;
            const n = Core.user.email.split('@')[0], v = i.value; 
            i.value = ''; 
            
            // Просто отправляем в базу. Рендер произойдет через subscribe автоматически!
            await Core.sb.from('comments').insert([{message: v, nickname: n}]); 
        }
    },
    // ... остальной код (UI, Canvas, loop) без изменений
    UI() {
        document.getElementById('todo-in').onkeypress = (e) => { 
            if(e.key === 'Enter' && e.target.value) { 
                const d = document.createElement('div'); d.className = 'task'; d.innerText = '> ' + e.target.value.toUpperCase(); 
                d.onclick = () => d.remove(); document.getElementById('todo-list').prepend(d); e.target.value = ''; 
            } 
        };
        document.getElementById('chat-in').onkeypress = (e) => { if(e.key === 'Enter') Core.Chat.send(); };
    },

    Canvas: {
        init() {
            this.cvs = document.getElementById('starfield'); this.ctx = this.cvs.getContext('2d'); this.res();
            window.addEventListener('resize', () => this.res());
            this.stars = Array.from({length:200}, () => ({x:Math.random()*this.cvs.width, y:Math.random()*this.cvs.height, s:Math.random()*2, v:Math.random()*0.3, b:Math.random()}));
            this.debris = Array.from({length:25}, () => ({x:Math.random()*this.cvs.width, y:Math.random()*this.cvs.height, s:Math.random()*3+1, vx:-Math.random()*0.5}));
            this.crew = Array.from({length:3}, () => ({x:Math.random()*this.cvs.width, y:Math.random()*this.cvs.height, rot:Math.random()*6, vr:0.005, vx:(Math.random()-0.5)*0.3, vy:(Math.random()-0.5)*0.3}));
            this.ufo = {x:-100, y:350, p:[]}; this.comet = {x:-200, y:0, active:false};
        },
        res() { this.cvs.width = window.innerWidth; this.cvs.height = window.innerHeight; },
        drawAstro(a) {
            const ctx = this.ctx; ctx.save(); ctx.translate(a.x, a.y); ctx.rotate(a.rot);
            ctx.fillStyle = '#fff'; ctx.beginPath(); if(ctx.roundRect) ctx.roundRect(-8,-12,16,24,5); else ctx.rect(-8,-12,16,24); ctx.fill();
            ctx.fillStyle = '#111'; ctx.beginPath(); ctx.arc(0,-7,6,0,Math.PI*2); ctx.fill(); ctx.strokeStyle = '#0ff'; ctx.stroke();
            ctx.fillStyle = 'rgba(255,255,255,0.3)'; ctx.beginPath(); ctx.ellipse(-2,-8,3,2,1,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = '#ccc'; ctx.fillRect(-11,-8,3,15); ctx.restore();
        },
        drawUFO(u) {
            const ctx = this.ctx; u.x += 1.1; if(u.x > this.cvs.width + 150) u.x = -150;
            let uy = u.y + Math.sin(Date.now()/800) * 50;
            if(Date.now() % 3 === 0) u.p.push({x: u.x - 40, y: uy + (Math.random()*10 - 5), s: Math.random()*3+1, a: 1, vx: -Math.random()*2});
            for(let i = u.p.length - 1; i >= 0; i--) {
                let p = u.p[i]; p.x += p.vx; p.a -= 0.02; ctx.fillStyle = `rgba(0,242,255,${p.a})`; ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill(); if(p.a <= 0) u.p.splice(i, 1);
            }
            ctx.fillStyle = '#111'; ctx.beginPath(); ctx.ellipse(u.x, uy, 55, 16, 0, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#0ff'; ctx.lineWidth = 2; ctx.stroke();
            let d = ctx.createLinearGradient(u.x, uy-35, u.x, uy-10); d.addColorStop(0, 'rgba(0,242,255,0.7)'); d.addColorStop(1, 'transparent');
            ctx.fillStyle = d; ctx.beginPath(); ctx.ellipse(u.x, uy-11, 28, 20, 0, Math.PI, 0); ctx.fill(); ctx.stroke();
            for(let i=0; i<5; i++) { ctx.fillStyle = (Math.floor(Date.now()/150)%5 === i) ? '#f0f' : '#044'; ctx.beginPath(); ctx.arc(u.x-32+i*16, uy+3, 2, 0, Math.PI*2); ctx.fill(); }
        },
        draw() {
            const ctx = this.ctx, cvs = this.cvs; ctx.fillStyle = '#01050a'; ctx.fillRect(0,0,cvs.width,cvs.height);
            this.stars.forEach(s => { s.x -= s.v; if(s.x < 0) s.x = cvs.width; ctx.fillStyle = `rgba(255,255,255,${0.3 + Math.abs(Math.sin(Date.now()*0.001 + s.b*10))*0.7})`; ctx.beginPath(); ctx.arc(s.x, s.y, s.s/2, 0, Math.PI*2); ctx.fill(); });
            this.debris.forEach(d => { d.x += d.vx; if(d.x < -10) d.x = cvs.width + 10; ctx.fillStyle = 'rgba(0,242,255,0.1)'; ctx.fillRect(d.x, d.y, d.s, d.s); });
            if(!this.comet.active && Math.random() < 0.004) { this.comet.active = true; this.comet.x = -200; this.comet.y = Math.random() * cvs.height; }
            if(this.comet.active) { this.comet.x += 12; this.comet.y += 1.5; let g = ctx.createLinearGradient(this.comet.x, this.comet.y, this.comet.x-80, this.comet.y-5); g.addColorStop(0, '#fff'); g.addColorStop(1, 'transparent'); ctx.strokeStyle = g; ctx.beginPath(); ctx.moveTo(this.comet.x, this.comet.y); ctx.lineTo(this.comet.x-80, this.comet.y-5); ctx.stroke(); if(this.comet.x > cvs.width + 200) this.comet.active = false; }
            this.crew.forEach(a => { a.x += a.vx; a.y += a.vy; a.rot += a.vr; if(a.x < -50) a.x = cvs.width+50; if(a.y < -50) a.y = cvs.height+50; this.drawAstro(a); });
            const px = cvs.width * 0.85, py = cvs.height * 0.3;
            ctx.strokeStyle = 'rgba(0,242,255,0.1)'; ctx.lineWidth = 12; ctx.beginPath(); ctx.ellipse(px, py, 200, 45, 0.4, 0, Math.PI*2); ctx.stroke();
            let pg = ctx.createRadialGradient(px-30, py-30, 10, px, py, 110); pg.addColorStop(0, '#00f2ff'); pg.addColorStop(0.7, '#003344'); pg.addColorStop(1, '#01050a'); ctx.fillStyle = pg; ctx.beginPath(); ctx.arc(px, py, 110, 0, Math.PI*2); ctx.fill();
            this.drawUFO(this.ufo);
        }
    },
    loop() { Core.Canvas.draw(); requestAnimationFrame(() => Core.loop()); }
};
window.onload = () => Core.init();
</script>
</body>
</html>
