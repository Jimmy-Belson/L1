<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>DEEP SPACE TERMINAL v3.0</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --n: #00f2ff; --p: #ff00ff; --b: #02040a; --glass: rgba(0, 20, 40, 0.8); }
        body, html { margin: 0; padding: 0; background: var(--b); color: var(--n); font-family: 'Segoe UI', monospace; height: 100vh; overflow: hidden; }
        
        #canvas-bg { position: fixed; top: 0; left: 0; z-index: 1; }
        .ui-layer { position: relative; z-index: 10; display: flex; height: 100vh; pointer-events: none; }

        /* ИНТЕРФЕЙС */
        .sidebar { width: 300px; background: var(--glass); border-right: 2px solid var(--n); padding: 25px; pointer-events: auto; backdrop-filter: blur(10px); display: flex; flex-direction: column; }
        .main { flex-grow: 1; display: flex; justify-content: center; align-items: center; }
        .terminal { width: 550px; background: var(--glass); border: 1px solid var(--n); padding: 30px; pointer-events: auto; box-shadow: 0 0 40px rgba(0, 242, 255, 0.15); border-radius: 4px; }

        #chat-box { height: 380px; overflow-y: auto; padding-right: 10px; margin-bottom: 20px; border-bottom: 1px solid rgba(0, 242, 255, 0.2); }
        .msg { padding: 12px; border-left: 3px solid var(--p); background: rgba(255, 0, 255, 0.03); margin-bottom: 10px; cursor: pointer; animation: blink 0.5s ease-out; }
        @keyframes blink { from { opacity: 0; } to { opacity: 1; } }
        .msg:hover { background: rgba(255, 0, 0, 0.15); border-left-color: #ff4d4d; }
        .msg:hover::after { content: " [DELETE]"; color: #ff4d4d; font-size: 0.7em; margin-left: 10px; }

        input { background: #000; border: 1px solid var(--n); color: #fff; padding: 12px; width: calc(100% - 26px); outline: none; margin-bottom: 10px; border-radius: 4px; }
        button { background: var(--n); color: #000; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; }
        button:hover { background: var(--p); color: #fff; box-shadow: 0 0 20px var(--p); }

        .todo-item { background: rgba(0, 242, 255, 0.05); padding: 10px; margin-top: 10px; border-radius: 4px; border: 1px solid rgba(0, 242, 255, 0.1); cursor: pointer; }
        .todo-item:hover { border-color: var(--n); }
        .hidden { display: none; }
    </style>
</head>
<body>

<canvas id="canvas-bg"></canvas>

<div class="ui-layer">
    <div class="sidebar">
        <h2 style="letter-spacing: 3px; border-bottom: 2px solid var(--p); padding-bottom: 10px;">OPERATIONS</h2>
        <div id="todo-list">
            <input type="text" id="todo-in" placeholder="+ NEW OBJECTIVE" style="font-size: 0.7em;">
            <div class="todo-item" onclick="this.remove()">SCAN SECTOR 7G <span style="color: var(--p)">[!]</span></div>
            <div class="todo-item" onclick="this.remove()">FUEL STATUS: 88% <span style="color: #0f0">[OK]</span></div>
        </div>
        <div style="margin-top: auto; font-size: 0.8em; line-height: 1.8;">
            UPLINK: <span id="db-status" style="color: yellow;">CONNECTING...</span><br>
            SHIP_POS: <span id="coords" style="color: var(--p);">0, 0</span>
        </div>
    </div>

    <div class="main">
        <div class="terminal">
            <div id="auth-ui">
                <h1 style="text-align: center; letter-spacing: 5px;">AUTHORIZATION</h1>
                <input type="email" id="email" placeholder="PILOT EMAIL">
                <input type="password" id="pass" placeholder="ACCESS CODE">
                <button onclick="auth('in')">LOGIN</button>
                <button onclick="auth('up')" style="background:none; color:var(--p); border: 1px solid var(--p); margin-top:10px;">REGISTER</button>
            </div>

            <div id="chat-ui" class="hidden">
                <div id="chat-box"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="msg-in" placeholder="TYPE SIGNAL...">
                    <button onclick="send()" style="width: 100px;">SEND</button>
                </div>
                <button onclick="out()" style="background:none; color:#ff4d4d; border:1px solid #ff4d4d; margin-top:10px; font-size:0.7em;">LOGOUT</button>
            </div>
        </div>
    </div>
</div>

<script>
    // УБЕРИ ПРОБЕЛЫ В ЭТИХ СТРОКАХ:
    const G_URL = 'https://ebjsxlympwocluxgmwcu.supabase.co';
    const G_KEY = 'sb_publishable_8HhPj3Y8g5V7Np8Vy5xbzQ_2B7LjTkj';
    
    let db;
    try {
        db = window.supabase.createClient(G_URL, G_KEY);
        document.getElementById('db-status').innerText = 'ONLINE';
        document.getElementById('db-status').style.color = '#0f0';
    } catch(e) {
        document.getElementById('db-status').innerText = 'ERROR';
        document.getElementById('db-status').style.color = 'red';
    }

    // --- БАЗА ДАННЫХ ---
    db.auth.onAuthStateChange((_, s) => {
        document.getElementById('auth-ui').classList.toggle('hidden', !!s);
        document.getElementById('chat-ui').classList.toggle('hidden', !s);
        if(s) load();
    });

    async function auth(t) {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        const { error } = t === 'in' ? await db.auth.signInWithPassword({email:e, password:p}) : await db.auth.signUp({email:e, password:p});
        if(error) alert(error.message);
    }
    async function out() { await db.auth.signOut(); }

    async function load() {
        const { data } = await db.from('comments').select('*').order('created_at', { ascending: true });
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        if(data) data.forEach(m => {
            const d = document.createElement('div');
            d.className = 'msg';
            d.innerHTML = `<span style="color:var(--p); font-size:0.8em;">[${m.nickname}]:</span><br>${m.message}`;
            d.onclick = async () => { if(confirm("Удалить?")) { await db.from('comments').delete().eq('id', m.id); load(); } };
            box.appendChild(d);
        });
        box.scrollTop = box.scrollHeight;
    }

    async function send() {
        const i = document.getElementById('msg-in');
        const { data: { user } } = await db.auth.getUser();
        if(i.value && user) {
            const val = i.value; i.value = ''; // Мгновенно убираем текст
            await db.from('comments').insert([{ message: val, nickname: user.email.split('@')[0] }]);
            load();
        }
    }
    db.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, load).subscribe();

    // --- ГРАФИКА (ДЕТАЛИЗИРОВАННАЯ) ---
    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    let stars = [], particles = [];
    let ufo = { x: -200, y: 300, s: 2.5, t: 0 };

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize; resize();

    for(let i=0; i<600; i++) stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*2, o: Math.random() });

    function drawPlanet(x, y, r, col, hasRing) {
        let g = ctx.createRadialGradient(x-r*0.3, y-r*0.3, r*0.1, x, y, r);
        g.addColorStop(0, '#fff'); g.addColorStop(0.3, col); g.addColorStop(1, '#000');
        ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
        if(hasRing) {
            ctx.strokeStyle = "rgba(255,255,255,0.15)"; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.ellipse(x, y, r*2.2, r*0.5, Math.PI/4, 0, Math.PI*2); ctx.stroke();
        }
    }

    function drawShip() {
        ufo.x += ufo.s; ufo.t += 0.05;
        let shake = Math.sin(ufo.t)*5;
        if(ufo.x > canvas.width + 200) ufo.x = -200;

        // Корпус корабля (Серебристый металл)
        ctx.fillStyle = "#A0A0A0";
        ctx.beginPath(); ctx.ellipse(ufo.x, ufo.y + shake, 45, 12, 0, 0, Math.PI*2); ctx.fill();
        // Купол (Стеклянный)
        ctx.fillStyle = "rgba(0, 242, 255, 0.4)";
        ctx.beginPath(); ctx.arc(ufo.x, ufo.y - 5 + shake, 15, Math.PI, 0); ctx.fill();
        // Двигатели (Свечение)
        ctx.shadowBlur = 15; ctx.shadowColor = "#ff00ff";
        ctx.fillStyle = (Math.sin(ufo.t*5) > 0) ? "#ff00ff" : "#333";
        ctx.beginPath(); ctx.arc(ufo.x - 30, ufo.y + 5 + shake, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(ufo.x + 30, ufo.y + 5 + shake, 3, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
        
        document.getElementById('coords').innerText = `${Math.floor(ufo.x)}, ${Math.floor(ufo.y + shake)}`;
    }

    function loop() {
        ctx.fillStyle = "#02040a"; ctx.fillRect(0,0,canvas.width, canvas.height);
        
        stars.forEach(s => {
            ctx.fillStyle = `rgba(255,255,255,${s.o})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
            s.o += (Math.random()-0.5)*0.02;
        });

        drawPlanet(canvas.width*0.8, canvas.height*0.2, 80, "#ff4500", true); // Марс с кольцом
        drawPlanet(canvas.width*0.15, canvas.height*0.8, 50, "#00bfff", false); // Нептун

        drawShip();
        requestAnimationFrame(loop);
    }
    loop();

    // To-Do
    document.getElementById('todo-in').onkeypress = (e) => {
        if(e.key === 'Enter' && e.target.value) {
            const d = document.createElement('div');
            d.className = 'todo-item';
            d.innerHTML = `${e.target.value.toUpperCase()} <span style="color:red">[X]</span>`;
            d.onclick = () => d.remove();
            document.getElementById('todo-list').prepend(d);
            e.target.value = '';
        }
    }
</script>
</body>
</html>