<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ORBITRON TERMINAL v7.9</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --n: #00f2ff; --p: #ff00ff; --bg: #01050a; --gl: rgba(5, 15, 25, 0.9); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--n); font-family: 'Share Tech Mono', monospace; height: 100vh; overflow: hidden; }
        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; pointer-events: none; }
        .sidebar { width: 300px; height: 100%; background: var(--gl); border-right: 1px solid var(--n); padding: 25px; pointer-events: auto; backdrop-filter: blur(15px); display: flex; flex-direction: column; }
        .main-terminal-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .terminal-box { width: 650px; background: var(--gl); border: 1px solid var(--n); padding: 30px; pointer-events: auto; position: relative; backdrop-filter: blur(12px); border-radius: 4px; box-shadow: 0 0 40px rgba(0,242,255,0.15); }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-4px, 2px); filter: hue-rotate(90deg); } 100% { transform: translate(0); } }
        .glitch-active { animation: glitch 0.25s linear 2; }
        #chat-box { height: 400px; overflow-y: auto; margin-bottom: 20px; display: flex; flex-direction: column; }
        .msg { background: rgba(0, 242, 255, 0.03); border-left: 3px solid var(--n); padding: 10px; margin-bottom: 8px; font-size: 14px; }
        .todo-item { padding: 8px; border-bottom: 1px solid rgba(0,242,255,0.1); cursor: pointer; transition: 0.2s; font-size: 12px; }
        .todo-item:hover { background: rgba(255, 0, 255, 0.1); color: var(--p); }
        input { background: rgba(0,0,0,0.8); border: 1px solid var(--n); color: #fff; padding: 12px; width: 100%; font-family: inherit; outline: none; margin-bottom: 10px; }
        button { background: transparent; color: var(--n); border: 1px solid var(--n); padding: 10px; width: 100%; cursor: pointer; font-family: 'Orbitron'; text-transform: uppercase; transition: 0.3s; }
        button:hover { background: var(--n); color: #000; box-shadow: 0 0 15px var(--n); }
        h2 { font-family: 'Orbitron'; font-size: 12px; letter-spacing: 1px; margin-bottom: 10px; color: var(--p); }
        .hidden { display: none; }
    </style>
</head>
<body>

<canvas id="canvas-bg"></canvas>

<div class="ui-layer">
    <div class="sidebar">
        <h2>MISSION_LOGS</h2>
        <input type="text" id="todo-in" placeholder="> NEW ENTRY" style="font-size: 11px; padding: 8px;">
        <div id="todo-list" style="overflow-y:auto; flex-grow:1;"></div>
        <div style="margin-top: 15px; border-top: 1px solid rgba(0,242,255,0.2); padding-top:10px; font-size:10px;">
            <div id="sys-status">STATUS: STANDBY</div>
            <div id="clock">00:00:00</div>
        </div>
    </div>
    
    <div class="main-terminal-area">
        <div class="terminal-box" id="main-terminal">
            <div id="auth-ui">
                <h1 style="text-align: center; margin-bottom: 20px; font-family: 'Orbitron'; font-size: 16px;">TERMINAL_ACCESS</h1>
                <input type="email" id="email" placeholder="PILOT_ID">
                <input type="password" id="pass" placeholder="ACCESS_CODE">
                <button onclick="handleAuth('in')">LOGIN</button>
                <button onclick="handleAuth('up')" style="margin-top:8px; border-color:var(--p); color:var(--p)">REGISTER</button>
            </div>
            
            <div id="chat-ui" class="hidden">
                <div id="chat-box"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="msg-in" placeholder="SIGNAL..." onkeypress="if(event.key==='Enter') sendMsg()">
                    <button onclick="sendMsg()" style="width: 100px;">SEND</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const URL = 'https://ebjsxlympwocluxgmwcu.supabase.co';
    const KEY = 'sb_publishable_8HhPj3Y8g5V7Np8Vy5xbzQ_2B7LjTkj';
    const sb = window.supabase.createClient(URL, KEY);

    // --- LOGIC: TODO LIST (FIXED) ---
    const todoIn = document.getElementById('todo-in');
    const todoList = document.getElementById('todo-list');

    todoIn.addEventListener('keypress', (e) => {
        if(e.key === 'Enter' && todoIn.value) {
            const div = document.createElement('div');
            div.className = 'todo-item';
            div.innerText = '> ' + todoIn.value.toUpperCase();
            div.onclick = () => div.remove();
            todoList.prepend(div);
            todoIn.value = '';
        }
    });

    // --- LOGIC: CHAT & AUTH ---
    window.getNickColor = (s) => {
        let h = 0;
        for(let i=0; i<s.length; i++) h = s.charCodeAt(i) + ((h << 5) - h);
        return 'hsl(' + (Math.abs(h) % 360) + ', 80%, 75%)';
    };

    window.handleAuth = async (type) => {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        const { error } = type === 'in' ? await sb.auth.signInWithPassword({email: e, password: p}) : await sb.auth.signUp({email: e, password: p});
        if(error) alert(error.message);
    };

    sb.auth.onAuthStateChange((event, session) => {
        const isAuth = !!session;
        document.getElementById('auth-ui').classList.toggle('hidden', isAuth);
        document.getElementById('chat-ui').classList.toggle('hidden', !isAuth);
        if(isAuth) {
            document.getElementById('sys-status').innerText = "STATUS: ONLINE";
            loadMessages();
        }
    });

    async function loadMessages() {
        const { data } = await sb.from('comments').select('*').order('created_at', {ascending: true});
        if(data) {
            const box = document.getElementById('chat-box'); box.innerHTML = '';
            data.forEach(m => renderMessage(m));
            box.scrollTop = box.scrollHeight;
        }
    }

    function renderMessage(m) {
        const box = document.getElementById('chat-box');
        const d = document.createElement('div'); d.className = 'msg';
        const nick = m.nickname || 'Pilot';
        d.innerHTML = '<span style="color:'+getNickColor(nick)+'; font-weight:bold;">'+nick+':</span> ' + m.message;
        box.appendChild(d); box.scrollTop = box.scrollHeight;
    }

    window.sendMsg = async () => {
        const input = document.getElementById('msg-in');
        const { data: { user } } = await sb.auth.getUser();
        if(input.value && user) {
            const nick = user.email.split('@')[0], msg = input.value;
            input.value = '';
            await sb.from('comments').insert([{message: msg, nickname: nick}]);
            renderMessage({nickname: nick, message: msg});
        }
    };

    sb.channel('public:comments').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments' }, payload => {
        sb.auth.getUser().then(({data}) => {
            if(data.user && data.user.email.split('@')[0] !== payload.new.nickname) {
                renderMessage(payload.new);
                const t = document.getElementById('main-terminal');
                t.classList.add('glitch-active');
                setTimeout(() => t.classList.remove('glitch-active'), 300);
            }
        });
    }).subscribe();

    // --- ENGINE: COSMOS (ASTRONAUTS FIX) ---
    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    let stars = [], stones = [], astronauts = [], ufo = { x: -100, y: 150 };

    function init() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        stars = Array.from({length: 100}, () => ({x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*1.5}));
        stones = Array.from({length: 5}, () => ({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: 0.3 + Math.random()*0.5,
            p: [{x:-15,y:-10}, {x:15,y:-12}, {x:20,y:10}, {x:0,y:15}, {x:-18,y:8}]
        }));
        astronauts = Array.from({length: 3}, () => ({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: 0.2, vy: 0.1, r: Math.random()*6
        }));
    }

    function drawAstronaut(x, y, rot) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rot);
        
        // Backpack
        ctx.fillStyle = '#aaa';
        ctx.beginPath();
        ctx.roundRect(-12, -8, 8, 16, 2);
        ctx.fill();

        // Suit (Body)
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        ctx.roundRect(-7, -11, 14, 22, 5);
        ctx.fill();

        // Visor
        ctx.fillStyle = '#1a1a1a';
        ctx.beginPath();
        ctx.roundRect(-4, -8, 9, 6, 2);
        ctx.fill();
        
        // Visor Reflection
        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.fillRect(-2, -7, 2, 2);
        
        ctx.restore();
    }

    function draw() {
        ctx.fillStyle = '#01050a'; ctx.fillRect(0,0,canvas.width, canvas.height);
        
        ctx.fillStyle = '#fff';
        stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, 7); ctx.fill(); });

        // Planet
        ctx.fillStyle = '#004466'; ctx.beginPath(); ctx.arc(canvas.width*0.85, canvas.height*0.2, 60, 0, 7); ctx.fill();
        ctx.strokeStyle = 'rgba(0,242,255,0.1)'; ctx.beginPath(); ctx.ellipse(canvas.width*0.85, canvas.height*0.2, 160, 40, 0.4, 0, 7); ctx.stroke();

        stones.forEach(s => {
            s.y += s.s; if(s.y > canvas.height + 50) s.y = -50;
            ctx.save(); ctx.translate(s.x, s.y); ctx.fillStyle = '#1a2533'; ctx.beginPath();
            s.p.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
            ctx.fill(); ctx.restore();
        });

        astronauts.forEach(a => {
            a.x += a.vx; a.y += a.vy; a.r += 0.005;
            if(a.x > canvas.width + 50) a.x = -50;
            drawAstronaut(a.x, a.y, a.r);
        });

        // UFO
        ufo.x += 1; if(ufo.x > canvas.width + 150) ufo.x = -150;
        let uy = ufo.y + Math.sin(Date.now()/500)*15;
        ctx.fillStyle = '#2c2c2c'; ctx.beginPath(); ctx.ellipse(ufo.x, uy, 40, 10, 0, 0, 7); ctx.fill();
        ctx.fillStyle = 'rgba(0,242,255,0.5)'; ctx.beginPath(); ctx.arc(ufo.x, uy-4, 12, 3.14, 0); ctx.fill();
        ctx.fillStyle = (Math.floor(Date.now()/250)%2===0) ? '#0ff' : '#f0f';
        ctx.beginPath(); ctx.arc(ufo.x, uy+2, 3, 0, 7); ctx.fill();

        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        requestAnimationFrame(draw);
    }

    window.addEventListener('resize', init);
    init(); draw();
})();
</script>
</body>
</html>