<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORBITRON_BETA</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --neon: #00f2ff; --pink: #ff00ff; --bg: #01050a; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Orbitron', sans-serif; cursor: crosshair; }
        
        /* Убираем полосы прокрутки везде */
        body, html { 
            background: var(--bg); 
            color: #fff; 
            overflow: hidden; 
            height: 100vh; 
            width: 100vw;
        }

        #starfield { position: fixed; top: 0; left: 0; z-index: 0; pointer-events: none; }

        /* HUD СЕТКА */
        .hud-layer { 
            position: relative; 
            z-index: 10; 
            display: grid; 
            grid-template-columns: 320px 1fr 320px; 
            grid-template-rows: auto 1fr;
            height: 100vh; 
            padding: 20px; 
            gap: 20px; 
            pointer-events: none; 
        }
        .hud-layer > * { pointer-events: auto; }

        header { 
            grid-column: 1 / 4; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid rgba(0,242,255,0.3); 
            padding-bottom: 15px; 
        }
        
        .logo { font-size: 24px; font-weight: 900; letter-spacing: 5px; color: var(--neon); text-shadow: 0 0 15px var(--neon); }
        
        .panel { 
            background: rgba(0,20,40,0.6); 
            border: 1px solid rgba(0,242,255,0.2); 
            backdrop-filter: blur(10px); 
            padding: 20px; 
            position: relative;
            height: fit-content;
        }

        /* ЧАТ - ФИКС СПРАВА */
        #chat-panel { 
            display: flex; 
            flex-direction: column; 
            height: 500px; /* Фиксированная высота как в оригинале */
            align-self: end; /* Прижать к низу */
        }
        
        #chat-stream { 
            flex: 1; 
            overflow-y: auto; 
            margin-bottom: 10px; 
        }
        
        /* Скрываем ужасные полоски скролла в чате */
        #chat-stream::-webkit-scrollbar { width: 0px; background: transparent; }

        .msg-container { 
            margin-bottom: 10px; 
            padding: 8px; 
            border-left: 2px solid var(--pink); 
            background: rgba(255,0,255,0.05); 
        }
        
        /* НИКИ СТАЛИ ЖИРНЫМИ */
        .msg-nick { 
            color: var(--neon); 
            font-weight: 900 !important; 
            font-size: 13px; 
            text-transform: uppercase;
        }
        
        .msg-time { color: var(--pink); font-size: 10px; font-weight: 700; }
        .msg-text { font-size: 13px; margin-top: 4px; color: #e0e0e0; }

        input { 
            background: rgba(0,0,0,0.5); 
            border: 1px solid var(--neon); 
            color: var(--neon); 
            padding: 10px; 
            outline: none; 
            width: 100%; 
        }

        /* ОРИГИНАЛЬНЫЙ ЛОГИН */
        #auth-gate { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .auth-box { width: 350px; text-align: center; }
        .btn { border: 1px solid var(--neon); color: var(--neon); padding: 10px 20px; margin-top: 10px; cursor: pointer; transition: 0.3s; width: 100%; text-align: center; }
        .btn:hover { background: var(--neon); color: #000; }
        .hidden { display: none !important; }

        /* МОБИЛЬНАЯ ВЕРСИЯ - УМЕНЬШЕННЫЙ ЧАТ */
        @media (max-width: 768px) {
            .hud-layer { 
                grid-template-columns: 1fr; 
                grid-template-rows: auto auto 1fr auto;
                padding: 10px; 
                overflow-y: auto;
            }
            #chat-panel { height: 200px !important; order: 4; }
            #todo-panel { order: 2; }
            header { grid-column: 1; order: 1; }
        }
    </style>
</head>
<body>

<div id="auth-gate">
    <div class="panel auth-box">
        <h2 class="logo" style="margin-bottom:20px">LOGIN</h2>
        <input type="email" id="email" placeholder="PILOT_EMAIL" style="margin-bottom:10px">
        <input type="password" id="pass" placeholder="ACCESS_CODE">
        <div class="btn" onclick="Core.Auth()">INITIATE_SESSION</div>
        <div class="btn" onclick="Core.Register()" style="border-color:var(--pink); color:var(--pink); margin-top:5px">CREATE_NEW_PILOT</div>
    </div>
</div>

<canvas id="starfield"></canvas>

<div class="hud-layer">
    <header>
        <div class="logo">ORBITRON</div>
        <div id="clock" style="font-size: 20px; color: var(--pink)">00:00:00</div>
        <div id="audio-btn" onclick="Core.Audio.toggle()" style="cursor:pointer">
            <div style="display:flex; align-items:center">
                <div class="bar"></div><div class="bar"></div><div class="bar"></div>
            </div>
        </div>
    </header>

    <aside id="todo-panel" class="panel">
        <h3 style="color:var(--pink); margin-bottom:15px">// MISSION_TASKS</h3>
        <input type="text" id="todo-in" placeholder="+ NEW_TASK">
        <div id="todo-list" style="margin-top:15px"></div>
    </aside>

    <main></main>

    <aside id="chat-panel" class="panel">
        <h3 style="color:var(--neon); margin-bottom:10px">// COMM_LINK</h3>
        <div id="chat-stream"></div>
        <input type="text" id="chat-in" placeholder="TYPE_MESSAGE...">
    </aside>
</div>

<script>
// Твой скрипт Core остается без изменений, чтобы всё работало
const Core = {
    sb: window.supabase.createClient('https://ebjsxlympwocluxgmwcu.supabase.co', 'sb_publishable_8HhPj3Y8g5V7Np8Vy5xbzQ_2B7LjTkj'),
    user: null,
    
    init() {
        this.Canvas.init(); 
        this.Audio.setup(); 
        this.UI();
        setInterval(() => {
            const el = document.getElementById('clock');
            if(el) el.innerText = new Date().toLocaleTimeString('ru-RU', { hour12: false });
        }, 1000);
        this.sb.auth.onAuthStateChange((_, s) => { 
            if(s) { 
                this.user = s.user; 
                document.getElementById('auth-gate').classList.add('hidden'); 
                this.Chat.load(); 
            }
        });
        this.loop();
    },

    Auth: async () => {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        const { error } = await Core.sb.auth.signInWithPassword({email:e, password:p});
        if(error) alert(error.message);
    },

    Register: async () => {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        const { error } = await Core.sb.auth.signUp({email:e, password:p});
        if(error) alert(error.message); else alert("PILOT_CREATED");
    },

    Audio: {
        setup() { this.el = new Audio('track.mp3'); this.el.loop = true; this.el.volume = 0.3; },
        toggle() {
            const b = document.getElementById('audio-btn');
            if(this.el.paused) { this.el.play(); b.classList.add('playing'); } 
            else { this.el.pause(); b.classList.remove('playing'); }
        }
    },

    Chat: {
        async load() { 
            const { data } = await Core.sb.from('comments').select('*').order('created_at', {ascending:true}); 
            if(data) { document.getElementById('chat-stream').innerHTML = ''; data.forEach(m => this.render(m)); } 
        },
        render(m) { 
            const s = document.getElementById('chat-stream'), d = document.createElement('div'); 
            d.className = 'msg-container';
            const time = new Date(m.created_at || Date.now()).toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'});
            d.innerHTML = `<div style="display:flex;justify-content:space-between"><span class="msg-nick">${(m.nickname||'PILOT')}</span><span class="msg-time">${time}</span></div><div class="msg-text">${m.message}</div>`; 
            s.appendChild(d); s.scrollTop = s.scrollHeight; 
        },
        async send() { 
            const i = document.getElementById('chat-in'); 
            if(!i.value || !Core.user) return;
            const n = Core.user.email.split('@')[0], v = i.value; 
            i.value = ''; 
            Core.Chat.render({nickname: n, message: v, created_at: new Date()}); 
            await Core.sb.from('comments').insert([{message: v, nickname: n}]); 
        }
    },

    UI() {
        document.getElementById('todo-in').onkeypress = (e) => { 
            if(e.key === 'Enter' && e.target.value) { 
                const d = document.createElement('div'); 
                d.style.padding = '5px 0';
                d.innerText = '> ' + e.target.value.toUpperCase(); 
                document.getElementById('todo-list').prepend(d); 
                e.target.value = ''; 
            } 
        };
        document.getElementById('chat-in').onkeypress = (e) => { if(e.key === 'Enter') Core.Chat.send(); };
    },

    Canvas: {
        init() {
            this.cvs = document.getElementById('starfield'); this.ctx = this.cvs.getContext('2d'); this.res();
            window.addEventListener('resize', () => this.res());
            this.stars = Array.from({length:200}, () => ({x:Math.random()*this.cvs.width, y:Math.random()*this.cvs.height, s:Math.random()*2, v:Math.random()*0.3, b:Math.random()}));
            this.ufo = {x:-100, y:350, p:[]};
        },
        res() { this.cvs.width = window.innerWidth; this.cvs.height = window.innerHeight; },
        draw() {
            const ctx = this.ctx, cvs = this.cvs; ctx.fillStyle = '#01050a'; ctx.fillRect(0,0,cvs.width,cvs.height);
            this.stars.forEach(s => { 
                s.x -= s.v; if(s.x < 0) s.x = cvs.width; 
                ctx.fillStyle = `rgba(255,255,255,${0.3 + Math.abs(Math.sin(Date.now()*0.001 + s.b*10))*0.7})`; 
                ctx.beginPath(); ctx.arc(s.x, s.y, s.s/2, 0, Math.PI*2); ctx.fill(); 
            });
            // Планета
            const px = cvs.width * 0.85, py = cvs.height * 0.3;
            let pg = ctx.createRadialGradient(px-30, py-30, 10, px, py, 110);
            pg.addColorStop(0, '#00f2ff'); pg.addColorStop(1, '#01050a');
            ctx.fillStyle = pg; ctx.beginPath(); ctx.arc(px, py, 110, 0, Math.PI*2); ctx.fill();
        }
    },
    loop() { Core.Canvas.draw(); requestAnimationFrame(() => Core.loop()); }
};
window.onload = () => Core.init();
</script>
</body>
</html>
