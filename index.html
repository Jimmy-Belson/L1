<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ORBITRON TERMINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --neon: #00f2ff; 
            --pink: #ff00ff; 
            --bg: #010812;
            --glass: rgba(10, 25, 47, 0.7);
        }

        * { transition: all 0.2s ease; }

        body, html { 
            margin: 0; padding: 0; 
            background: var(--bg); 
            color: var(--neon); 
            font-family: 'Share Tech Mono', monospace; 
            height: 100vh; overflow: hidden; 
        }

        #canvas-bg { position: fixed; top: 0; left: 0; z-index: 1; }

        /* UI LAYOUT */
        .interface { 
            position: relative; z-index: 10; 
            display: flex; height: 100vh; 
            background: radial-gradient(circle at center, transparent 0%, rgba(1, 8, 18, 0.8) 100%);
            pointer-events: none;
        }

        .sidebar { 
            width: 320px; background: var(--glass); 
            border-right: 1px solid var(--neon); 
            padding: 30px; pointer-events: auto; 
            backdrop-filter: blur(15px); 
            box-shadow: 15px 0 50px rgba(0,0,0,0.5);
        }

        .main-hub { flex-grow: 1; display: flex; justify-content: center; align-items: center; }

        /* TERMINAL STYLE */
        .terminal { 
            width: 500px; background: var(--glass); 
            border: 1px solid var(--neon); 
            padding: 30px; pointer-events: auto; 
            position: relative; border-radius: 2px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.1);
        }

        .terminal::before {
            content: "SECURE_CONNECTION_ACTIVE";
            position: absolute; top: -10px; left: 20px;
            background: var(--bg); padding: 0 10px; font-size: 0.7rem; color: var(--pink);
        }

        h1, h2, h3 { font-family: 'Orbitron', sans-serif; letter-spacing: 3px; text-transform: uppercase; }

        /* CHAT */
        #chat-box { 
            height: 350px; overflow-y: auto; 
            margin-bottom: 20px; padding-right: 15px; 
            scrollbar-width: thin; scrollbar-color: var(--neon) transparent;
        }

        .msg { 
            background: rgba(0, 242, 255, 0.05); 
            border: 1px solid rgba(0, 242, 255, 0.1);
            padding: 12px; margin-bottom: 12px; 
            position: relative; cursor: pointer;
        }

        .msg:hover { background: rgba(255, 0, 255, 0.1); border-color: var(--pink); }
        .msg-nick { color: var(--pink); font-size: 0.75rem; display: block; margin-bottom: 4px; }

        /* INPUTS */
        input { 
            background: rgba(0,0,0,0.5); border: 1px solid var(--neon); 
            color: #fff; padding: 12px; width: calc(100% - 26px); 
            font-family: 'Share Tech Mono', monospace; outline: none; margin-bottom: 10px;
        }
        
        input:focus { box-shadow: 0 0 15px var(--neon); }

        button { 
            background: transparent; color: var(--neon); 
            border: 1px solid var(--neon); padding: 12px; 
            width: 100%; cursor: pointer; font-family: 'Orbitron', sans-serif;
            font-weight: bold; font-size: 0.8rem;
        }

        button:hover { background: var(--neon); color: #000; box-shadow: 0 0 20px var(--neon); }

        /* TODO */
        .todo-item { 
            padding: 10px; border-bottom: 1px solid rgba(0, 242, 255, 0.2); 
            display: flex; justify-content: space-between; font-size: 0.8rem; cursor: pointer;
        }
        .todo-item:hover { color: var(--pink); background: rgba(255, 255, 255, 0.05); }

        .hidden { display: none; }
    </style>
</head>
<body>

<canvas id="canvas-bg"></canvas>

<div class="interface">
    <div class="sidebar">
        <h3>SYSTEM_LOG</h3>
        <div id="todo-list">
            <input type="text" id="todo-in" placeholder="> ADD TASK">
            <div class="todo-item">DEEP_SPACE_SCAN <span>[WAIT]</span></div>
            <div class="todo-item">OXYGEN_LEVEL <span>[99%]</span></div>
        </div>
        
        <div style="margin-top: auto; font-size: 0.7rem; border-top: 1px solid var(--neon); padding-top: 10px; opacity: 0.6;">
            PILOT_STATUS: ONLINE <br>
            SHIP_MODEL: ORBITRON-V3 <br>
            COORDINATES: <span id="pos-display">0.0.0</span>
        </div>
    </div>

    <div class="main-hub">
        <div class="terminal">
            <div id="auth-ui">
                <h2 style="text-align: center">ACCESS_GATE</h2>
                <input type="email" id="email" placeholder="LOGIN_ID">
                <input type="password" id="pass" placeholder="SECURITY_CODE">
                <button onclick="auth('in')">ESTABLISH_LINK</button>
            </div>

            <div id="chat-ui" class="hidden">
                <div id="chat-box"></div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="msg-in" placeholder="TYPE SIGNAL...">
                    <button onclick="send()" style="width: 80px;">SEND</button>
                </div>
                <button onclick="out()" style="margin-top: 10px; border-color: var(--pink); color: var(--pink); font-size: 0.6rem;">TERMINATE</button>
            </div>
        </div>
    </div>
</div>

<script>
    const G_URL = 'https://ebjsxlympwocluxgmwcu.supabase.co';
    const G_KEY = 'sb_publishable_8HhPj3Y8g5V7Np8Vy5xbzQ_2B7LjTkj';
    const sb = window.supabase.createClient(G_URL, G_KEY);

    // --- AUTH & CHAT LOGIC ---
    sb.auth.onAuthStateChange((_, s) => {
        document.getElementById('auth-ui').classList.toggle('hidden', !!s);
        document.getElementById('chat-ui').classList.toggle('hidden', !s);
        if(s) load();
    });

    async function auth(t) {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        const { error } = t === 'in' ? await sb.auth.signInWithPassword({email:e, password:p}) : await sb.auth.signUp({email:e, password:p});
        if(error) alert("ERR: " + error.message);
    }
    async function out() { await sb.auth.signOut(); }

    async function load() {
        const { data } = await sb.from('comments').select('*').order('created_at', { ascending: true });
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        if(data) data.forEach(m => {
            const d = document.createElement('div');
            d.className = 'msg';
            d.innerHTML = `<span class="msg-nick">${m.nickname}</span>${m.message}`;
            d.onclick = async () => { if(confirm("DELETE?")) { await sb.from('comments').delete().eq('id', m.id); load(); } };
            box.appendChild(d);
        });
        box.scrollTop = box.scrollHeight;
    }

    async function send() {
        const i = document.getElementById('msg-in');
        const { data: { user } } = await sb.auth.getUser();
        if(i.value && user) {
            const txt = i.value; i.value = '';
            await sb.from('comments').insert([{ message: txt, nickname: user.email.split('@')[0] }]);
            load();
        }
    }
    sb.channel('chat').on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, load).subscribe();

    // --- COSMIC ENGINE 4.0 (CANVAS) ---
    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    let stars = [], stones = [], astronauts = [];

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize; resize();

    // Init Stars
    for(let i=0; i<400; i++) stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*1.5 });
    
    // Init Simple Stones (Камешки)
    for(let i=0; i<12; i++) {
        stones.push({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height,
            size: Math.random()*10+5, s: Math.random()*0.5+0.2, rot: Math.random()*Math.PI
        });
    }

    // Init Simple Astronauts
    for(let i=0; i<3; i++) {
        astronauts.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: 0.3, vy: 0.2, rot: 0 });
    }

    function drawAstronaut(a) {
        ctx.save();
        ctx.translate(a.x, a.y);
        ctx.rotate(a.rot);
        // Тело (упрощенный мультяшный стиль)
        ctx.fillStyle = "white";
        ctx.fillRect(-10, -10, 20, 25); // Туловище
        ctx.fillStyle = "#333";
        ctx.fillRect(-7, -7, 14, 8); // Стекло шлема
        ctx.fillStyle = "white";
        ctx.fillRect(-12, -2, 4, 10); // Рука л
        ctx.fillRect(8, -2, 4, 10);  // Рука п
        ctx.restore();
        a.x += a.vx; a.y += a.vy; a.rot += 0.005;
        if(a.x > canvas.width + 50) a.x = -50;
    }

    function drawStone(s) {
        ctx.fillStyle = "#2c3e50";
        ctx.save();
        ctx.translate(s.x, s.y);
        ctx.rotate(s.rot);
        ctx.beginPath();
        for(let i=0; i<6; i++) {
            let angle = (i/6)*Math.PI*2;
            let r = s.size + (Math.sin(i*2)*3);
            ctx.lineTo(Math.cos(angle)*r, Math.sin(angle)*r);
        }
        ctx.closePath();
        ctx.fill();
        ctx.restore();
        s.y += s.s; s.rot += 0.01;
        if(s.y > canvas.height + 50) s.y = -50;
    }

    function drawGrid() {
        ctx.strokeStyle = "rgba(0, 242, 255, 0.05)";
        ctx.lineWidth = 1;
        for(let i=0; i<canvas.width; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, canvas.height); ctx.stroke(); }
        for(let i=0; i<canvas.height; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width, i); ctx.stroke(); }
    }

    function loop() {
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg');
        ctx.fillRect(0,0,canvas.width, canvas.height);
        
        drawGrid();

        stars.forEach(s => {
            ctx.fillStyle = "white";
            ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
        });

        stones.forEach(drawStone);
        astronauts.forEach(drawAstronaut);

        // UFO (Корабль из прошлого кода)
        drawUFO();

        requestAnimationFrame(loop);
    }

    let ufoX = -100;
    function drawUFO() {
        ufoX += 1.5; if(ufoX > canvas.width + 100) ufoX = -100;
        ctx.fillStyle = "#7f8c8d";
        ctx.beginPath(); ctx.ellipse(ufoX, 150, 40, 12, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "rgba(0, 242, 255, 0.4)";
        ctx.beginPath(); ctx.arc(ufoX, 145, 15, Math.PI, 0); ctx.fill();
        document.getElementById('pos-display').innerText = Math.floor(ufoX) + ".14.0";
    }

    loop();

    // To-Do Logic
    document.getElementById('todo-in').onkeypress = (e) => {
        if(e.key === 'Enter' && e.target.value) {
            const d = document.createElement('div');
            d.className = 'todo-item';
            d.innerHTML = `${e.target.value.toUpperCase()} <span>[NEW]</span>`;
            d.onclick = () => d.remove();
            document.getElementById('todo-list').prepend(d);
            e.target.value = '';
        }
    }
</script>
</body>
</html>