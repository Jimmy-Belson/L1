<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TERMINAL - DEEP SPACE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --n: #00f2ff; --p: #ff00ff; --b: #020205; }
        body, html { margin: 0; padding: 0; background: var(--b); color: var(--n); font-family: 'Courier New', monospace; height: 100vh; overflow: hidden; }
        
        #canvas-bg { position: fixed; top: 0; left: 0; z-index: 1; pointer-events: none; }
        .ui-layer { position: relative; z-index: 10; display: flex; height: 100vh; background: radial-gradient(circle, transparent 20%, var(--b) 80%); }

        /* ЛЕВАЯ ПАНЕЛЬ */
        .sidebar { width: 300px; background: rgba(0, 10, 20, 0.9); border-right: 2px solid var(--n); padding: 20px; box-shadow: 5px 0 20px rgba(0, 242, 255, 0.2); }
        .todo-item { border: 1px solid rgba(0, 242, 255, 0.3); padding: 8px; margin: 10px 0; font-size: 0.8em; cursor: pointer; display: flex; justify-content: space-between; }
        .todo-item:hover { border-color: var(--p); background: rgba(255, 0, 255, 0.1); }

        /* ОСНОВНОЙ БЛОК */
        .main { flex-grow: 1; display: flex; justify-content: center; align-items: center; }
        .terminal { width: 500px; background: rgba(0, 5, 10, 0.8); border: 1px solid var(--n); padding: 20px; position: relative; backdrop-filter: blur(5px); }
        .terminal::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, rgba(0,0,0,0.1) 1px, transparent 2px); pointer-events: none; }

        #chat-box { height: 350px; overflow-y: auto; padding: 10px; border-bottom: 1px solid var(--n); margin-bottom: 15px; }
        .msg { padding: 8px; border-left: 2px solid var(--p); margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
        .msg:hover { background: rgba(255, 0, 0, 0.2); border-left-color: red; }
        .msg:hover::after { content: " [DELETE?]"; color: red; font-size: 0.7em; }
        .msg-nick { color: var(--p); font-weight: bold; font-size: 0.8em; }

        input { background: #000; border: 1px solid var(--n); color: var(--n); padding: 10px; width: calc(100% - 22px); outline: none; margin-bottom: 10px; }
        button { background: var(--n); color: #000; border: none; padding: 10px; width: 100%; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        button:hover { background: var(--p); color: #fff; }

        .hidden { display: none; }
        .scanline { position: fixed; top: 0; width: 100%; height: 2px; background: rgba(0, 242, 255, 0.1); z-index: 100; animation: scan 4s linear infinite; }
        @keyframes scan { from { top: 0; } to { top: 100%; } }
    </style>
</head>
<body>

<div class="scanline"></div>
<canvas id="canvas-bg"></canvas>

<div class="ui-layer">
    <div class="sidebar">
        <h3>MISSIONS_LOG</h3>
        <input type="text" id="todo-in" placeholder="ADD TASK...">
        <div id="todo-list">
            <div class="todo-item">CALIBRATE SENSORS <span>[OK]</span></div>
            <div class="todo-item">VOID SCANNING <span>[..]</span></div>
        </div>
        <div style="margin-top: 100px; font-size: 0.7em; opacity: 0.5;">
            LATENCY: 14ms<br>
            UPLINK: ACTIVE<br>
            <span id="coords">0.00, 0.00</span>
        </div>
    </div>

    <div class="main">
        <div class="terminal">
            <div id="auth-ui">
                <h2 style="text-align:center">SECURE LOGIN</h2>
                <input type="email" id="email" placeholder="PILOT_MAIL">
                <input type="password" id="pass" placeholder="PASSWORD">
                <button onclick="auth('in')">LOGIN</button>
                <button onclick="auth('up')" style="background:none; color:var(--p); margin-top:5px;">REGISTER</button>
            </div>

            <div id="chat-ui" class="hidden">
                <div id="chat-box"></div>
                <input type="text" id="msg-in" placeholder="ENTER MESSAGE...">
                <button onclick="send()">TRANSMIT</button>
                <button onclick="out()" style="background:none; color:red; border:1px solid red; margin-top:10px; font-size:0.7em;">ABORT SESSION</button>
            </div>
        </div>
    </div>
</div>

<script>
    const URL = 'https://ebjsxlympwocluxgmwcu.supabase.co';
    const KEY = 'sb_publishable_8HhPj3Y8g5V7Np8Vy5xbzQ_2B7LjTkj';
    const sb = window.supabase.createClient(URL, KEY);

    // --- AUTH & CHAT ---
    sb.auth.onAuthStateChange((_, s) => {
        document.getElementById('auth-ui').classList.toggle('hidden', !!s);
        document.getElementById('chat-ui').classList.toggle('hidden', !s);
        if(s) load();
    });

    async function auth(type) {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        const { error } = type === 'in' ? await sb.auth.signInWithPassword({email:e, password:p}) : await sb.auth.signUp({email:e, password:p});
        if(error) alert(error.message);
    }
    async function out() { await sb.auth.signOut(); }

    async function load() {
        const { data } = await sb.from('comments').select('*').order('created_at', { ascending: true });
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        if(data) data.forEach(m => addMsg(m));
        box.scrollTop = box.scrollHeight;
    }

    function addMsg(m) {
        const d = document.createElement('div');
        d.className = 'msg';
        d.innerHTML = `<span class="msg-nick">${m.nickname}:</span> <span style="color:#fff">${m.message}</span>`;
        d.onclick = async () => {
            if(confirm("Delete message?")) {
                await sb.from('comments').delete().eq('id', m.id);
                load();
            }
        };
        document.getElementById('chat-box').appendChild(d);
    }

    async function send() {
        const i = document.getElementById('msg-in');
        const { data: { user } } = await sb.auth.getUser();
        if(i.value && user) {
            const txt = i.value; i.value = '';
            await sb.from('comments').insert([{ message: txt, nickname: user.email.split('@')[0] }]);
            load();
        }
    }

    sb.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, load).subscribe();

    // --- GRAPHICS ENGINE ---
    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    let stars = [], ast = [];
    let ufo = { x: -100, y: 200, s: 2.5 };

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize; resize();

    for(let i=0; i<800; i++) stars.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*1.5, o: Math.random() });
    for(let i=0; i<10; i++) ast.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: Math.random()*10+2, s: Math.random()*1.5+0.5 });

    function drawPlanet(x, y, r, c1, c2) {
        ctx.save();
        let g = ctx.createRadialGradient(x - r*0.3, y - r*0.3, r*0.1, x, y, r);
        g.addColorStop(0, c1); g.addColorStop(1, c2);
        ctx.fillStyle = g;
        ctx.shadowBlur = 30; ctx.shadowColor = c1;
        ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }

    function drawUFO(x, y) {
        ctx.fillStyle = "#555"; // Металлический корпус
        ctx.beginPath(); ctx.ellipse(x, y, 35, 10, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "rgba(0, 242, 255, 0.5)"; // Голубой купол
        ctx.beginPath(); ctx.arc(x, y-4, 12, Math.PI, 0); ctx.fill();
        ctx.fillStyle = (Date.now() % 400 > 200) ? "#0f0" : "#f00"; // Мигание огней
        ctx.beginPath(); ctx.arc(x-20, y, 2, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x+20, y, 2, 0, Math.PI*2); ctx.fill();
    }

    function renderFrame() {
        ctx.fillStyle = "#020205"; ctx.fillRect(0,0,canvas.width, canvas.height);
        
        stars.forEach(s => {
            ctx.fillStyle = `rgba(255,255,255,${s.o})`;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
            s.o += (Math.random()-0.5)*0.05;
        });

        drawPlanet(canvas.width*0.8, canvas.height*0.2, 70, "#ff4400", "#220000");
        drawPlanet(canvas.width*0.2, canvas.height*0.7, 50, "#0088ff", "#000511");

        ast.forEach(a => {
            a.y += a.s; if(a.y > canvas.height) a.y = -20;
            ctx.fillStyle = "#444";
            ctx.beginPath(); ctx.arc(a.x, a.y, a.r, 0, Math.PI*2); ctx.fill();
        });

        ufo.x += ufo.s; if(ufo.x > canvas.width + 100) ufo.x = -100;
        drawUFO(ufo.x, ufo.y);

        document.getElementById('coords').innerText = `${ufo.x.toFixed(2)}, ${ufo.y.toFixed(2)}`;
        requestAnimationFrame(renderFrame);
    }
    renderFrame();

    // To-Do Logic
    document.getElementById('todo-in').onkeypress = (e) => {
        if(e.key === 'Enter' && e.target.value) {
            const d = document.createElement('div');
            d.className = 'todo-item';
            d.innerHTML = `${e.target.value.toUpperCase()} <span>[..]</span>`;
            d.onclick = () => d.remove();
            document.getElementById('todo-list').prepend(d);
            e.target.value = '';
        }
    }
</script>
</body>
</html>